<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Paxi iTechnologies</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico">
    <link rel="shortcut icon" href="/assets/images/favicon.ico">
    <link rel="apple-touch-icon" href="/assets/images/favicon.svg">
    <link rel="manifest" href="/assets/images/site.webmanifest">
    
    <!-- Systems - Load in order -->
    <script src="/services/path-manager.js?v=2.0.0"></script>
    <script src="/services/port-manager.js?v=2.0.0"></script>
    <script src="/services/api-path-manager.js?v=2.0.0"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #006d77;
            --secondary: #83c5be;
            --accent: #ffddd2;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --bg-light: #f9fafb;
            --border: #e5e7eb;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
        }
        
        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }
        
        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
        }
        
        .login-box h1 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            text-align: center;
        }
        
        .login-box p {
            color: var(--text-light);
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .password-wrapper {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-light);
            font-size: 1.2rem;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s;
        }
        
        .password-toggle:hover {
            color: var(--primary);
        }
        
        .password-wrapper input {
            padding-right: 3rem;
        }
        
        .forgot-password-link {
            text-align: right;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .forgot-password-link a {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.3s;
        }
        
        .forgot-password-link a:hover {
            color: var(--secondary);
            text-decoration: underline;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-header h2 {
            margin: 0;
            color: var(--primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
            transition: background 0.3s;
        }
        
        .modal-close:hover {
            background: var(--bg-light);
        }
        
        .btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #005a63;
        }
        
        .btn:disabled {
            background: var(--text-light);
            cursor: not-allowed;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .alert.error {
            background: #fee2e2;
            color: var(--error);
            border: 1px solid #fecaca;
        }
        
        .alert.success {
            background: #d1fae5;
            color: var(--success);
            border: 1px solid #a7f3d0;
        }
        
        /* Dashboard */
        .dashboard {
            display: none;
        }
        
        .dashboard.active {
            display: block;
        }
        
        .dashboard-header {
            background: white;
            padding: 1.5rem 2rem;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dashboard-header h1 {
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-info span {
            color: var(--text-light);
        }
        
        .dashboard-content {
            display: flex;
            min-height: calc(100vh - 80px);
        }
        
        .sidebar {
            width: 250px;
            background: white;
            border-right: 2px solid var(--border);
            padding: 2rem 0;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-menu li {
            margin-bottom: 0.5rem;
        }
        
        .sidebar-menu a {
            display: block;
            padding: 1rem 2rem;
            color: var(--text-dark);
            text-decoration: none;
            transition: background 0.3s;
            border-left: 3px solid transparent;
        }
        
        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: var(--bg-light);
            border-left-color: var(--primary);
            color: var(--primary);
        }
        
        .main-content {
            flex: 1;
            padding: 2rem;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-card .label {
            color: var(--text-light);
            margin-top: 0.5rem;
        }
        
        .table {
            width: 100%;
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .table th {
            background: var(--bg-light);
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .table tr:hover {
            background: var(--bg-light);
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            width: auto;
        }
        
        .btn-secondary {
            background: var(--secondary);
        }
        
        .btn-secondary:hover {
            background: #6bb3a8;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-light);
            cursor: pointer;
            padding: 0;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: var(--text-dark);
        }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="login-container">
        <div class="login-box">
            <h1>Admin Dashboard</h1>
            <p>Paxi iTechnologies Website Management</p>
            <div id="login-alert"></div>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="password" name="password" placeholder="Enter password" required>
                        <button type="button" class="password-toggle" id="password-toggle" aria-label="Toggle password visibility">
                            <span id="password-toggle-icon">üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>
                <div class="forgot-password-link">
                    <a href="#" onclick="event.preventDefault(); showForgotPasswordModal();">Forgot Password?</a>
                </div>
                <button type="submit" class="btn" id="login-btn">Login</button>
            </form>
            <div style="text-align: center; margin-top: 1rem;">
                <button type="button" class="btn btn-secondary" onclick="testConnection()" style="width: auto; padding: 0.5rem 1rem; font-size: 0.875rem;">Test Backend Connection</button>
            </div>
        </div>
    </div>
    
    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reset Password</h2>
                <button class="modal-close" onclick="closeForgotPasswordModal()">&times;</button>
            </div>
            <div id="forgot-password-alert"></div>
            <form id="forgot-password-form">
                <div class="form-group">
                    <label for="reset-email">Email Address</label>
                    <input type="email" id="reset-email" name="email" placeholder="Enter your email address" required>
                </div>
                <button type="submit" class="btn" id="reset-btn">Send Reset Link</button>
                <button type="button" class="btn btn-secondary" onclick="closeForgotPasswordModal()" style="margin-top: 0.5rem;">Cancel</button>
            </form>
        </div>
    </div>
    
    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="dashboard-header">
            <h1>Admin Dashboard</h1>
            <div class="user-info">
                <span id="username-display"></span>
                <button class="btn btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <div class="dashboard-content">
            <div class="sidebar">
                <ul class="sidebar-menu">
                    <li><a href="#" class="menu-link active" data-section="overview">üìä Overview</a></li>
                    <li><a href="#" class="menu-link" data-section="visitors">üëÅÔ∏è Visitors</a></li>
                    <li><a href="#" class="menu-link" data-section="chats">üí¨ Chat Conversations</a></li>
                    <li><a href="#" class="menu-link" data-section="pages">üìÑ Pages</a></li>
                    <li><a href="#" class="menu-link" data-section="services">üõ†Ô∏è Services</a></li>
                    <li><a href="#" class="menu-link" data-section="apps">üì± Apps</a></li>
                    <li><a href="#" class="menu-link" data-section="content">‚úèÔ∏è Content</a></li>
                    <li><a href="#" class="menu-link" data-section="users">üë• Users</a></li>
                    <li><a href="#" class="menu-link" data-section="messages">üìß Messages <span id="messages-badge" style="display: none; background: #ff4444; color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.75rem; margin-left: 5px;">0</span></a></li>
                    <li><a href="#" class="menu-link" data-section="media">üé¨ Media</a></li>
                    <li><a href="#" class="menu-link" data-section="settings">‚öôÔ∏è Settings</a></li>
                </ul>
            </div>
            
            <div class="main-content">
                <!-- Overview Section -->
                <div id="overview" class="content-section active">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>Dashboard Overview</h2>
                        <button class="btn btn-secondary" onclick="refreshDashboardStats()">üîÑ Refresh</button>
                    </div>
                    
                    <!-- Main Statistics Grid -->
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="font-size: 3rem;">üìÑ</div>
                                <div>
                                    <h3 style="margin: 0; font-size: 2.5rem; font-weight: bold;" id="total-pages">0</h3>
                                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Total Pages</p>
                                    <small style="opacity: 0.8;" id="recent-pages">0 modified recently</small>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="font-size: 3rem;">üõ†Ô∏è</div>
                                <div>
                                    <h3 style="margin: 0; font-size: 2.5rem; font-weight: bold;" id="total-services">0</h3>
                                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Total Services</p>
                                    <small style="opacity: 0.8;" id="services-categories">0 categories</small>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="font-size: 3rem;">‚úèÔ∏è</div>
                                <div>
                                    <h3 style="margin: 0; font-size: 2.5rem; font-weight: bold;" id="total-content">0</h3>
                                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Content Blocks</p>
                                    <small style="opacity: 0.8;" id="content-languages">0 languages</small>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="font-size: 3rem;">üë•</div>
                                <div>
                                    <h3 style="margin: 0; font-size: 2.5rem; font-weight: bold;" id="total-users">0</h3>
                                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Total Users</p>
                                    <small style="opacity: 0.8;" id="active-users">0 active</small>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="font-size: 3rem;">üìß</div>
                                <div>
                                    <h3 style="margin: 0; font-size: 2.5rem; font-weight: bold;" id="total-contact">0</h3>
                                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Contact Messages</p>
                                    <small style="opacity: 0.8;" id="unread-contact"><span id="unread-count">0</span> unread</small>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="font-size: 3rem;">üëÅÔ∏è</div>
                                <div>
                                    <h3 style="margin: 0; font-size: 2.5rem; font-weight: bold;" id="total-visitors">0</h3>
                                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Total Visitors</p>
                                    <small style="opacity: 0.8;" id="total-page-views">0 page views</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Statistics -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                        <!-- Services by Category -->
                        <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin-top: 0; color: var(--primary);">Services by Category</h3>
                            <div id="services-category-chart" style="margin-top: 1rem;">
                                <div style="text-align: center; padding: 2rem; color: var(--text-light);">Loading...</div>
                            </div>
                        </div>
                        
                        <!-- Users by Role -->
                        <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin-top: 0; color: var(--primary);">Users by Role</h3>
                            <div id="users-role-chart" style="margin-top: 1rem;">
                                <div style="text-align: center; padding: 2rem; color: var(--text-light);">Loading...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Statistics -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                        <!-- Content by Category -->
                        <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin-top: 0; color: var(--primary);">Content by Category</h3>
                            <div id="content-category-chart" style="margin-top: 1rem;">
                                <div style="text-align: center; padding: 2rem; color: var(--text-light);">Loading...</div>
                            </div>
                        </div>
                        
                        <!-- Content by Language -->
                        <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin-top: 0; color: var(--primary);">Content by Language</h3>
                            <div id="content-language-chart" style="margin-top: 1rem;">
                                <div style="text-align: center; padding: 2rem; color: var(--text-light);">Loading...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin-top: 0; color: var(--primary);">Recent Activity</h3>
                        <div id="recent-activity-list" style="margin-top: 1rem;">
                            <div style="text-align: center; padding: 2rem; color: var(--text-light);">Loading...</div>
                        </div>
                    </div>
                    
                    <!-- System Status -->
                    <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 1.5rem;">
                        <h3 style="margin-top: 0; color: var(--primary);">System Status</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div>
                                <strong>Last Updated:</strong>
                                <div id="system-last-updated" style="color: var(--text-light);">-</div>
                            </div>
                            <div>
                                <strong>Maintenance Mode:</strong>
                                <div id="system-maintenance" style="color: var(--text-light);">-</div>
                            </div>
                            <div>
                                <strong>Data Files:</strong>
                                <div id="system-data-files" style="color: var(--text-light);">-</div>
                            </div>
                            <div>
                                <strong>Recent Logins:</strong>
                                <div id="system-recent-logins" style="color: var(--text-light);">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Visitors Section -->
                <div id="visitors" class="content-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>Website Visitors</h2>
                        <button class="btn btn-secondary" onclick="loadVisitors()">üîÑ Refresh</button>
                    </div>
                    
                    <!-- Visitor Statistics Summary -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0; font-size: 2rem; font-weight: bold; color: var(--primary);" id="visitor-total">0</h3>
                            <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">Total Visitors</p>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0; font-size: 2rem; font-weight: bold; color: var(--primary);" id="visitor-pageviews">0</h3>
                            <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">Total Page Views</p>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0; font-size: 2rem; font-weight: bold; color: var(--primary);" id="visitor-unique">0</h3>
                            <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">Unique Visitors</p>
                        </div>
                    </div>
                    
                    <!-- Visitors Table -->
                    <div class="table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Country</th>
                                    <th>City</th>
                                    <th>Source</th>
                                    <th>Page Location</th>
                                    <th>First Visit</th>
                                    <th>Last Visit</th>
                                    <th>Page Views</th>
                                    <th>Device/ISP</th>
                                </tr>
                            </thead>
                            <tbody id="visitors-table-body">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 2rem;">Loading visitors...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- SEO Insights -->
                    <div style="margin-top: 2rem; background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin-top: 0; color: var(--primary);">üîç SEO Insights</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 1rem;">
                            <div>
                                <h4 style="color: var(--text-dark); margin-bottom: 0.5rem;">Traffic Sources</h4>
                                <div id="traffic-sources-list" style="margin-top: 0.5rem;">
                                    <div style="text-align: center; padding: 1rem; color: var(--text-light);">Loading...</div>
                                </div>
                            </div>
                            <div>
                                <h4 style="color: var(--text-dark); margin-bottom: 0.5rem;">Search Queries</h4>
                                <div id="search-queries-list" style="margin-top: 0.5rem;">
                                    <div style="text-align: center; padding: 1rem; color: var(--text-light);">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Pages -->
                    <div style="margin-top: 2rem; background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin-top: 0; color: var(--primary);">Top Pages</h3>
                        <div id="top-pages-list" style="margin-top: 1rem;">
                            <div style="text-align: center; padding: 2rem; color: var(--text-light);">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Pages Section -->
                <div id="pages" class="content-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>Pages Management</h2>
                        <button class="btn btn-primary" onclick="showCreatePageModal()">+ Create New Page</button>
                    </div>
                    <div class="table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Page Name</th>
                                    <th>URL</th>
                                    <th>Size</th>
                                    <th>Last Modified</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pages-table-body">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 2rem;">Loading pages...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Page Editor Modal -->
                <div id="page-editor-modal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 90%; width: 1200px; max-height: 90vh;">
                        <div class="modal-header">
                            <h3 id="modal-title">Edit Page</h3>
                            <button class="modal-close" onclick="closePageEditor()">&times;</button>
                        </div>
                        <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 120px);">
                            <div class="form-group">
                                <label>Page Name</label>
                                <input type="text" id="page-name-input" placeholder="page-name.html" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                            </div>
                            <div class="form-group">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <label>Page Content (HTML)</label>
                                    <div>
                                        <button class="btn btn-sm btn-secondary" onclick="showMediaPicker()" style="margin-right: 0.5rem;">üì∑ Insert Media</button>
                                        <button class="btn btn-sm btn-secondary" onclick="previewPage()" style="margin-right: 0.5rem;">Preview</button>
                                        <button class="btn btn-sm btn-secondary" onclick="formatHTML()">Format</button>
                                    </div>
                                </div>
                                <textarea id="page-content-input" style="width: 100%; min-height: 500px; padding: 1rem; border: 2px solid var(--border); border-radius: 0.5rem; font-family: 'Courier New', monospace; font-size: 0.9rem;" placeholder="<!DOCTYPE html>..."></textarea>
                            </div>
                            <div id="page-editor-alert" style="margin-top: 1rem;"></div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1rem; border-top: 1px solid var(--border);">
                            <button class="btn btn-secondary" onclick="closePageEditor()">Cancel</button>
                            <button class="btn btn-primary" onclick="savePage()">Save Page</button>
                        </div>
                    </div>
                </div>
                
                <!-- Page Preview Modal -->
                <div id="page-preview-modal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 95%; width: 1400px; max-height: 95vh;">
                        <div class="modal-header">
                            <h3>Page Preview</h3>
                            <button class="modal-close" onclick="closePreview()">&times;</button>
                        </div>
                        <div class="modal-body" style="overflow-y: auto; max-height: calc(95vh - 120px);">
                            <iframe id="page-preview-frame" style="width: 100%; min-height: 600px; border: 1px solid var(--border); border-radius: 0.5rem;"></iframe>
                        </div>
                    </div>
                </div>
                
                <!-- Media Picker Modal -->
                <div id="media-picker-modal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 90%; width: 1000px; max-height: 90vh;">
                        <div class="modal-header">
                            <h3>Select Media</h3>
                            <button class="modal-close" onclick="closeMediaPicker()">&times;</button>
                        </div>
                        <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 120px);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div>
                                    <select id="media-picker-filter" onchange="filterMediaPicker()" style="padding: 0.5rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                        <option value="all">All Types</option>
                                        <option value="image">Images Only</option>
                                        <option value="video">Videos Only</option>
                                    </select>
                                </div>
                                <label for="media-picker-upload" class="btn btn-sm btn-primary" style="cursor: pointer;">
                                    üì§ Upload New
                                </label>
                                <input type="file" id="media-picker-upload" multiple accept="image/*,video/*" style="display: none;" onchange="handleMediaPickerUpload(event)">
                            </div>
                            <div id="media-picker-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;"></div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1rem; border-top: 1px solid var(--border);">
                            <button class="btn btn-secondary" onclick="closeMediaPicker()">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <!-- Services Section -->
                <div id="services" class="content-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>Services Management</h2>
                        <button class="btn btn-primary" onclick="showCreateServiceModal()">+ Create New Service</button>
                    </div>
                    <div class="table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Icon</th>
                                    <th>Service Name</th>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="services-table-body">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 2rem;">Loading services...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Apps Section -->
                <div id="apps" class="content-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>Apps Management</h2>
                        <button class="btn btn-primary" onclick="showCreateAppModal()">+ Create New App</button>
                    </div>
                    <div class="table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Icon</th>
                                    <th>App Name</th>
                                    <th>Status</th>
                                    <th>Link</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="apps-table-body">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem;">Loading apps...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- App Editor Modal -->
                <div id="app-editor-modal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 90%; width: 800px; max-height: 90vh;">
                        <div class="modal-header">
                            <h3 id="app-modal-title">Edit App</h3>
                            <button class="modal-close" onclick="closeAppEditor()">&times;</button>
                        </div>
                        <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 120px);">
                            <div class="form-group">
                                <label>App Name *</label>
                                <input type="text" id="app-name-input" placeholder="App Name" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;" required>
                            </div>
                            <div class="form-group">
                                <label>Icon (Emoji)</label>
                                <input type="text" id="app-icon-input" placeholder="üöÄ" maxlength="2" style="width: 100px; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                            </div>
                            <div class="form-group">
                                <label>Description *</label>
                                <textarea id="app-description-input" placeholder="App description..." style="width: 100%; min-height: 100px; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;" required></textarea>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="app-status-input" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                    <option value="coming-soon">Coming Soon</option>
                                    <option value="live">Live</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>App Link (URL)</label>
                                <input type="url" id="app-link-input" placeholder="https://your-app-url.com" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                <small style="color: var(--text-light);">Required for "Live" apps. Leave empty for "Coming Soon" apps.</small>
                            </div>
                            <div id="app-editor-alert" style="margin-top: 1rem;"></div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1rem; border-top: 1px solid var(--border);">
                            <button class="btn btn-secondary" onclick="closeAppEditor()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveApp()">Save App</button>
                        </div>
                    </div>
                </div>
                
                <!-- Service Editor Modal -->
                <div id="service-editor-modal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 90%; width: 1000px; max-height: 90vh;">
                        <div class="modal-header">
                            <h3 id="service-modal-title">Edit Service</h3>
                            <button class="modal-close" onclick="closeServiceEditor()">&times;</button>
                        </div>
                        <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 120px);">
                            <div class="form-group">
                                <label>Service Name *</label>
                                <input type="text" id="service-name-input" placeholder="Service Name" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;" required>
                            </div>
                            <div class="form-group">
                                <label>Icon (Emoji)</label>
                                <input type="text" id="service-icon-input" placeholder="üìã" maxlength="2" style="width: 100px; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select id="service-category-input" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                    <option value="consulting">Consulting</option>
                                    <option value="management">Management</option>
                                    <option value="infrastructure">Infrastructure</option>
                                    <option value="operations">Operations</option>
                                    <option value="automation">Automation</option>
                                    <option value="events">Events</option>
                                    <option value="methodology">Methodology</option>
                                    <option value="general">General</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Description *</label>
                                <textarea id="service-description-input" placeholder="Service description..." style="width: 100%; min-height: 100px; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;" required></textarea>
                            </div>
                            <div class="form-group">
                                <label>Details (one per line)</label>
                                <textarea id="service-details-input" placeholder="Detail 1&#10;Detail 2&#10;Detail 3" style="width: 100%; min-height: 150px; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;"></textarea>
                                <small style="color: var(--text-light);">Enter each detail on a new line</small>
                            </div>
                            <div class="form-group">
                                <label>Additional Fields (JSON format, optional)</label>
                                <textarea id="service-extra-input" placeholder='{"certifications": ["PMP", "ITIL"], "technologies": ["Azure", "AWS"]}' style="width: 100%; min-height: 100px; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem; font-family: 'Courier New', monospace; font-size: 0.9rem;"></textarea>
                                <small style="color: var(--text-light);">Optional: certifications, technologies, platforms, experience, methodology</small>
                            </div>
                            <div id="service-editor-alert" style="margin-top: 1rem;"></div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1rem; border-top: 1px solid var(--border);">
                            <button class="btn btn-secondary" onclick="closeServiceEditor()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveService()">Save Service</button>
                        </div>
                    </div>
                </div>
                
                <!-- Content Section -->
                <div id="content" class="content-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>Content Editor</h2>
                        <button class="btn btn-primary" onclick="showCreateContentModal()">+ Create New Content Block</button>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="margin-right: 1rem;">Filter by Category:</label>
                        <select id="content-category-filter" onchange="filterContentBlocks()" style="padding: 0.5rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                            <option value="">All Categories</option>
                            <option value="homepage">Homepage</option>
                            <option value="about">About</option>
                            <option value="services">Services</option>
                            <option value="contact">Contact</option>
                            <option value="general">General</option>
                        </select>
                    </div>
                    <div class="table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Type</th>
                                    <th>Category</th>
                                    <th>Languages</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="content-table-body">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem;">Loading content blocks...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Content Editor Modal -->
                <div id="content-editor-modal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 90%; width: 1100px; max-height: 90vh;">
                        <div class="modal-header">
                            <h3 id="content-modal-title">Edit Content Block</h3>
                            <button class="modal-close" onclick="closeContentEditor()">&times;</button>
                        </div>
                        <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 120px);">
                            <div class="form-group">
                                <label>Content Key *</label>
                                <input type="text" id="content-key-input" placeholder="hero-title" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;" required>
                                <small style="color: var(--text-light);">Unique identifier for this content block (e.g., hero-title, about-mission)</small>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label>Type</label>
                                    <select id="content-type-input" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                        <option value="text">Text</option>
                                        <option value="html">HTML</option>
                                        <option value="markdown">Markdown</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Category</label>
                                    <select id="content-category-input" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                        <option value="homepage">Homepage</option>
                                        <option value="about">About</option>
                                        <option value="services">Services</option>
                                        <option value="contact">Contact</option>
                                        <option value="general">General</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" id="content-description-input" placeholder="Brief description of this content block" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                            </div>
                            <div class="form-group">
                                <label>Content (Multi-language) *</label>
                                <div style="border: 2px solid var(--border); border-radius: 0.5rem; padding: 1rem; background: var(--bg-light);">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div>
                                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">English (en)</label>
                                            <textarea id="content-en-input" placeholder="English content..." style="width: 100%; min-height: 120px; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem;" required></textarea>
                                        </div>
                                        <div>
                                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">French (fr)</label>
                                            <textarea id="content-fr-input" placeholder="French content..." style="width: 100%; min-height: 120px; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem;" required></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="content-editor-alert" style="margin-top: 1rem;"></div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1rem; border-top: 1px solid var(--border);">
                            <button class="btn btn-secondary" onclick="closeContentEditor()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveContentBlock()">Save Content Block</button>
                        </div>
                    </div>
                </div>
                
                <!-- Users Section -->
                <div id="users" class="content-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>User Management</h2>
                        <button class="btn btn-primary" onclick="showCreateUserModal()">+ Create New User</button>
                    </div>
                    <div class="table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem;">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- User Editor Modal -->
                <div id="user-editor-modal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 90%; width: 800px; max-height: 90vh;">
                        <div class="modal-header">
                            <h3 id="user-modal-title">Edit User</h3>
                            <button class="modal-close" onclick="closeUserEditor()">&times;</button>
                        </div>
                        <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 120px);">
                            <div class="form-group">
                                <label>Username *</label>
                                <input type="text" id="user-username-input" placeholder="username" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;" required>
                            </div>
                            <div class="form-group">
                                <label>Email *</label>
                                <input type="email" id="user-email-input" placeholder="user@example.com" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;" required>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label>Role</label>
                                    <select id="user-role-input" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                        <option value="admin">Admin</option>
                                        <option value="super_admin">Super Admin</option>
                                        <option value="editor">Editor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Status</label>
                                    <select id="user-status-input" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label id="user-password-label">Password *</label>
                                <input type="password" id="user-password-input" placeholder="New password" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                <small style="color: var(--text-light);">Minimum 6 characters</small>
                            </div>
                            <div id="user-editor-alert" style="margin-top: 1rem;"></div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1rem; border-top: 1px solid var(--border);">
                            <button class="btn btn-secondary" onclick="closeUserEditor()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveUser()">Save User</button>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Conversations Section -->
                <div id="chats" class="content-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>Chat Conversations</h2>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <button class="btn btn-secondary" onclick="loadChatConversations()">üîÑ Refresh</button>
                            <select id="chats-filter" onchange="filterChats()" style="padding: 0.5rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                <option value="all">All Conversations</option>
                                <option value="recent">Recent (Last 24h)</option>
                                <option value="today">Today</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Chat Statistics -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0; font-size: 2rem; font-weight: bold; color: var(--primary);" id="chat-total">0</h3>
                            <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">Total Conversations</p>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0; font-size: 2rem; font-weight: bold; color: var(--primary);" id="chat-sessions">0</h3>
                            <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">Unique Sessions</p>
                        </div>
                    </div>
                    
                    <!-- Chat Conversations Table -->
                    <div class="table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Session ID</th>
                                    <th>User Message</th>
                                    <th>AI Response</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="chats-table-body">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 2rem;">Loading conversations...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Messages Section -->
                <div id="messages" class="content-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>Contact Messages</h2>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <button id="messages-refresh-btn" class="btn btn-secondary" onclick="loadContactMessages(true)">üîÑ Refresh</button>
                            <select id="messages-filter" onchange="filterMessages()" style="padding: 0.5rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                <option value="all">All Messages</option>
                                <option value="unread">Unread Only</option>
                            </select>
                            <div id="messages-alert" style="display: none; padding: 0.5rem 1rem; background: #d4edda; color: #155724; border-radius: 0.5rem; border: 1px solid #c3e6cb;"></div>
                        </div>
                    </div>
                    <div class="table">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 50px;">Status</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Subject</th>
                                    <th>Date</th>
                                    <th>Email Sent</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="messages-table-body">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 2rem;">Loading messages...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Message View Modal -->
                <div id="message-view-modal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 90%; width: 800px; max-height: 90vh;">
                        <div class="modal-header">
                            <h3 id="message-modal-title">Contact Message</h3>
                            <button class="modal-close" onclick="closeMessageView()">&times;</button>
                        </div>
                        <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 120px);">
                            <div id="message-view-content">
                                <div style="margin-bottom: 1rem;">
                                    <strong>From:</strong> <span id="message-view-name"></span> (<span id="message-view-email"></span>)
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>Phone:</strong> <span id="message-view-phone"></span>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>Subject:</strong> <span id="message-view-subject"></span>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>Date:</strong> <span id="message-view-date"></span>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>IP Address:</strong> <span id="message-view-ip"></span>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>Email Status:</strong> <span id="message-view-email-status"></span>
                                </div>
                                <hr style="margin: 1.5rem 0;">
                                <div style="margin-bottom: 1rem;">
                                    <strong>Message:</strong>
                                </div>
                                <div id="message-view-message" style="background: var(--bg-light); padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap; line-height: 1.6;"></div>
                            </div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1rem; border-top: 1px solid var(--border);">
                            <button class="btn btn-secondary" onclick="closeMessageView()">Close</button>
                            <a id="message-reply-link" href="#" target="_blank" class="btn btn-primary">üìß Reply via Email</a>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Section -->
                <div id="settings" class="content-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>Website Settings</h2>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-secondary" onclick="showChangePasswordModal()">üîí Change Password</button>
                            <button class="btn btn-secondary" onclick="showPermissionsModal()">üõ°Ô∏è Manage Permissions</button>
                        </div>
                    </div>
                    <div id="settings-loading" style="text-align: center; padding: 2rem;">Loading settings...</div>
                    <div id="settings-content" style="display: none;">
                        <form id="settings-form">
                            <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                                <h3 style="margin-bottom: 1rem; color: var(--primary);">Site Information</h3>
                                <div class="form-group">
                                    <label>Site Name</label>
                                    <input type="text" id="setting-site-name" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                </div>
                                <div class="form-group">
                                    <label>Domain</label>
                                    <input type="text" id="setting-site-domain" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="setting-site-email" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="text" id="setting-site-phone" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                </div>
                                <div class="form-group">
                                    <label>Address</label>
                                    <textarea id="setting-site-address" style="width: 100%; min-height: 80px; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;"></textarea>
                                </div>
                            </div>
                            
                            <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                                <h3 style="margin-bottom: 1rem; color: var(--primary);">SEO Settings</h3>
                                <div class="form-group">
                                    <label>Default Title</label>
                                    <input type="text" id="setting-seo-title" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                </div>
                                <div class="form-group">
                                    <label>Default Description</label>
                                    <textarea id="setting-seo-description" style="width: 100%; min-height: 80px; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Keywords (comma-separated)</label>
                                    <input type="text" id="setting-seo-keywords" placeholder="keyword1, keyword2, keyword3" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                </div>
                            </div>
                            
                            <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                                <h3 style="margin-bottom: 1rem; color: var(--primary);">Social Media</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>Facebook URL</label>
                                        <input type="url" id="setting-social-facebook" placeholder="https://facebook.com/..." style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                    </div>
                                    <div class="form-group">
                                        <label>Twitter URL</label>
                                        <input type="url" id="setting-social-twitter" placeholder="https://twitter.com/..." style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                    </div>
                                    <div class="form-group">
                                        <label>LinkedIn URL</label>
                                        <input type="url" id="setting-social-linkedin" placeholder="https://linkedin.com/..." style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                    </div>
                                    <div class="form-group">
                                        <label>Instagram URL</label>
                                        <input type="url" id="setting-social-instagram" placeholder="https://instagram.com/..." style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                                <h3 style="margin-bottom: 1rem; color: var(--primary);">Features</h3>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="setting-feature-maintenance" style="width: auto;">
                                        Maintenance Mode
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="setting-feature-registration" style="width: auto;">
                                        Allow Registration
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="setting-feature-comments" style="width: auto;">
                                        Enable Comments
                                    </label>
                                </div>
                            </div>
                            
                            <div id="settings-alert" style="margin-bottom: 1rem;"></div>
                            
                            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                                <button type="button" class="btn btn-secondary" onclick="resetSettingsForm()">Reset</button>
                                <button type="submit" class="btn btn-primary">Save Settings</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Change Password Modal -->
                <div id="change-password-modal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 90%; width: 500px;">
                        <div class="modal-header">
                            <h3>Change Password</h3>
                            <button class="modal-close" onclick="closeChangePasswordModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Current Password *</label>
                                <input type="password" id="change-password-current" placeholder="Enter current password" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;" required>
                            </div>
                            <div class="form-group">
                                <label>New Password *</label>
                                <input type="password" id="change-password-new" placeholder="Enter new password (min 6 characters)" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;" required>
                                <small style="color: var(--text-light);">Minimum 6 characters</small>
                            </div>
                            <div class="form-group">
                                <label>Confirm New Password *</label>
                                <input type="password" id="change-password-confirm" placeholder="Confirm new password" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;" required>
                            </div>
                            <div id="change-password-alert" style="margin-top: 1rem;"></div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1rem; border-top: 1px solid var(--border);">
                            <button class="btn btn-secondary" onclick="closeChangePasswordModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="savePasswordChange()">Change Password</button>
                        </div>
                    </div>
                </div>
                
                <!-- Password Reset Request Modal -->
                <div id="password-reset-modal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 90%; width: 500px;">
                        <div class="modal-header">
                            <h3>Reset Password</h3>
                            <button class="modal-close" onclick="closePasswordResetModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Email Address *</label>
                                <input type="email" id="reset-password-email" placeholder="Enter your email address" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;" required>
                                <small style="color: var(--text-light);">A reset token will be sent to your email</small>
                            </div>
                            <div id="reset-password-alert" style="margin-top: 1rem;"></div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1rem; border-top: 1px solid var(--border);">
                            <button class="btn btn-secondary" onclick="closePasswordResetModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="requestPasswordReset()">Send Reset Link</button>
                        </div>
                    </div>
                </div>
                
                <!-- Permissions Management Modal -->
                <div id="permissions-modal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 90%; width: 1000px; max-height: 90vh;">
                        <div class="modal-header">
                            <h3>Manage Permissions</h3>
                            <button class="modal-close" onclick="closePermissionsModal()">&times;</button>
                        </div>
                        <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 120px);">
                            <div id="permissions-loading" style="text-align: center; padding: 2rem;">Loading permissions...</div>
                            <div id="permissions-content" style="display: none;">
                                <div id="permissions-form"></div>
                            </div>
                            <div id="permissions-alert" style="margin-top: 1rem;"></div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1rem; border-top: 1px solid var(--border);">
                            <button class="btn btn-secondary" onclick="closePermissionsModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="savePermissions()">Save Permissions</button>
                        </div>
                    </div>
                </div>
                
                <!-- Media Management Section -->
                <div id="media" class="content-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>Media Library</h2>
                        <div style="display: flex; gap: 1rem;">
                            <label for="media-upload-input" class="btn btn-primary" style="cursor: pointer;">
                                üì§ Upload Media
                            </label>
                            <input type="file" id="media-upload-input" multiple accept="image/*,video/*,audio/*,.pdf" style="display: none;" onchange="handleMediaUpload(event)">
                        </div>
                    </div>
                    
                    <div id="media-loading" style="text-align: center; padding: 2rem;">Loading media...</div>
                    <div id="media-content" style="display: none;">
                        <div id="media-filter" style="margin-bottom: 1rem;">
                            <select id="media-type-filter" onchange="filterMedia()" style="padding: 0.5rem; border: 2px solid var(--border); border-radius: 0.5rem;">
                                <option value="all">All Types</option>
                                <option value="image">Images</option>
                                <option value="video">Videos</option>
                                <option value="audio">Audio</option>
                                <option value="document">Documents</option>
                            </select>
                        </div>
                        <div id="media-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let sessionId = null;
        let currentUser = null;
        
        // API URL helper using PMS (Path Manager System) - Handles HTTPS via Nginx proxy
        function getAPIUrl(path) {
            const protocol = window.location.protocol;
            const cleanPath = path.startsWith('/') ? path : '/' + path;
            
            // HTTPS: Use relative path through Nginx reverse proxy
            if (protocol === 'https:') {
                return cleanPath;
            }
            
            // HTTP: Use PMS correctly - RESPECT PMS PATHS
            if (window.PMS && typeof window.PMS.getBaseURL === 'function' && typeof window.PMS.api === 'function') {
                try {
                    // PMS.getBaseURL('api') returns base URL like "http://localhost:8000"
                    const baseURL = window.PMS.getBaseURL('api');
                    // PMS.api() already handles /api prefix correctly
                    // Pass the path as-is (it already has /api/admin/contact-messages)
                    const apiPath = window.PMS.api(cleanPath);
                    // Combine: baseURL + apiPath
                    // baseURL is "http://localhost:8000", apiPath is "/api/admin/contact-messages"
                    const fullUrl = baseURL + apiPath;
                    return fullUrl;
                } catch (error) {
                    console.error('‚ö†Ô∏è Error constructing PMS API URL:', error);
                    // Fallback
                    const hostname = window.location.hostname;
                    const port = 8000;
                    return `http://${hostname}:${port}${cleanPath}`;
                }
            }
            // Fallback only if PMS not loaded
            console.warn('‚ö†Ô∏è PMS not available, using fallback');
            const hostname = window.location.hostname;
            const port = 8000;
            return `http://${hostname}:${port}${cleanPath}`;
        }
        
        // Test backend connection - Use getAPIUrl() helper for HTTPS compatibility
        async function testConnection() {
            const alertDiv = document.getElementById('login-alert');
            alertDiv.innerHTML = '<div class="alert" style="background: #fff3cd; color: #856404;">Testing backend connection...</div>';
            
            try {
                // Use getAPIUrl() helper which handles HTTPS correctly
                const apiUrl = getAPIUrl('/api/admin/status');
                console.log('üîó Testing API URL:', apiUrl);
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (response.ok) {
                    alertDiv.innerHTML = '<div class="alert success">‚úÖ Backend is reachable!</div>';
                } else {
                    alertDiv.innerHTML = '<div class="alert error">‚ö†Ô∏è Backend responded but authentication required</div>';
                }
            } catch (error) {
                alertDiv.innerHTML = `<div class="alert error">‚ùå Cannot connect to backend: ${error.message}<br><small>Make sure the server is running: ./start.sh or node server.js</small></div>`;
            }
        }
        
        // Password visibility toggle
        function initPasswordToggle() {
            const passwordInput = document.getElementById('password');
            const passwordToggle = document.getElementById('password-toggle');
            const passwordToggleIcon = document.getElementById('password-toggle-icon');
            
            if (passwordToggle && passwordInput && passwordToggleIcon) {
                passwordToggle.addEventListener('click', function() {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    passwordToggleIcon.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
                });
            }
        }
        
        // Forgot Password Modal Functions
        function showForgotPasswordModal() {
            const modal = document.getElementById('forgot-password-modal');
            if (modal) {
                modal.classList.add('active');
                setTimeout(() => {
                    const emailInput = document.getElementById('reset-email');
                    if (emailInput) emailInput.focus();
                }, 100);
            }
        }
        
        function closeForgotPasswordModal() {
            const modal = document.getElementById('forgot-password-modal');
            if (modal) {
                modal.classList.remove('active');
                const form = document.getElementById('forgot-password-form');
                const alertDiv = document.getElementById('forgot-password-alert');
                if (form) form.reset();
                if (alertDiv) alertDiv.innerHTML = '';
            }
        }
        
        // Forgot Password Form Handler
        function initForgotPasswordForm() {
            const forgotPasswordForm = document.getElementById('forgot-password-form');
            if (forgotPasswordForm) {
                forgotPasswordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('reset-email').value.trim();
                    const alertDiv = document.getElementById('forgot-password-alert');
                    const resetBtn = document.getElementById('reset-btn');
                    
                    if (!email) {
                        if (alertDiv) alertDiv.innerHTML = '<div class="alert error">‚ùå Please enter your email address</div>';
                        return;
                    }
                    
                    resetBtn.disabled = true;
                    resetBtn.textContent = 'Sending...';
                    if (alertDiv) alertDiv.innerHTML = '<div class="alert" style="background: #fff3cd; color: #856404;">Sending reset request...</div>';
                    
                    try {
                        const apiUrl = getAPIUrl('/api/admin/password-reset-request');
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ email })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            if (alertDiv) alertDiv.innerHTML = '<div class="alert success">‚úÖ ' + (data.message || 'If the email exists, a password reset link has been sent.') + '</div>';
                            setTimeout(() => {
                                closeForgotPasswordModal();
                            }, 3000);
                        } else {
                            if (alertDiv) alertDiv.innerHTML = '<div class="alert error">‚ùå ' + (data.message || 'Failed to send reset request') + '</div>';
                        }
                    } catch (error) {
                        if (alertDiv) alertDiv.innerHTML = '<div class="alert error">‚ùå Error: ' + error.message + '</div>';
                    } finally {
                        resetBtn.disabled = false;
                        resetBtn.textContent = 'Send Reset Link';
                    }
                });
            }
            
            // Close modal when clicking outside
            const forgotPasswordModal = document.getElementById('forgot-password-modal');
            if (forgotPasswordModal) {
                forgotPasswordModal.addEventListener('click', function(e) {
                    if (e.target === forgotPasswordModal) {
                        closeForgotPasswordModal();
                    }
                });
            }
        }
        
        // Check if already logged in
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize password toggle
            initPasswordToggle();
            
            // Initialize forgot password form
            initForgotPasswordForm();
            
            // Test connection on load
            testConnection();
            
            const savedSession = localStorage.getItem('admin_session');
            if (savedSession) {
                sessionId = savedSession;
                checkSession();
            }
        });
        
        // Login form handler
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('login-btn');
            const alertDiv = document.getElementById('login-alert');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';
            alertDiv.innerHTML = '';
            
            try {
                const apiUrl = getAPIUrl('/api/admin/login');
                console.log('üîó Login API URL:', apiUrl);
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                // Check response status and structure
                if (!response.ok) {
                    showAlert('error', data.message || `Login failed: ${response.status} ${response.statusText}`);
                    console.error('Login failed:', response.status, data);
                    return;
                }
                
                // Log successful response for debugging - DETAILED
                console.log('=== LOGIN RESPONSE DEBUG ===');
                console.log('Status:', response.status);
                console.log('Response OK:', response.ok);
                console.log('Full response data:', JSON.stringify(data, null, 2));
                console.log('data.success:', data.success);
                console.log('data.data:', data.data);
                console.log('data.data type:', typeof data.data);
                console.log('data.data.sessionId:', data.data ? data.data.sessionId : 'N/A');
                console.log('data.sessionId (direct):', data.sessionId);
                console.log('===========================');
                
                // Handle successful login response
                if (data.success) {
                    // Try multiple possible locations for sessionId
                    let foundSessionId = null;
                    let foundUsername = null;
                    
                    if (data.data && data.data.sessionId) {
                        // Standard nested structure: data.data.sessionId
                        foundSessionId = data.data.sessionId;
                        foundUsername = data.data.username;
                    } else if (data.sessionId) {
                        // Root level: data.sessionId
                        foundSessionId = data.sessionId;
                        foundUsername = data.username || data.data?.username || username;
                    }
                    
                    if (foundSessionId) {
                        sessionId = foundSessionId;
                        currentUser = foundUsername || username;
                        localStorage.setItem('admin_session', sessionId);
                        console.log('‚úÖ Login successful! Session:', sessionId);
                        console.log('‚úÖ Username:', currentUser);
                        showDashboard();
                    } else {
                        // Success but no sessionId found anywhere
                        showAlert('error', 'Login successful but no session received. Please try again.');
                        console.error('‚ùå Login response missing sessionId. Full response:', data);
                    }
                } else {
                    // Login failed
                    showAlert('error', data.message || 'Login failed. Please check your credentials.');
                    console.error('Login failed:', data);
                }
            } catch (error) {
                showAlert('error', `Connection error: ${error.message}<br><small>Make sure the server is running on port 8000</small>`);
                console.error('Login error:', error);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        });
        
        // Check session
        async function checkSession() {
            if (!sessionId) return;
            
            try {
                const apiUrl = getAPIUrl('/api/admin/status');
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.data && data.data.authenticated) {
                    // Session is valid
                    currentUser = data.data.username || 'Admin';
                    showDashboard();
                    loadDashboardData();
                } else {
                    // Session invalid or expired
                    localStorage.removeItem('admin_session');
                    sessionId = null;
                    currentUser = null;
                }
            } catch (error) {
                console.error('Session check error:', error);
                // On error, clear session
                localStorage.removeItem('admin_session');
                sessionId = null;
                currentUser = null;
            }
        }
        
        // Show dashboard
        function showDashboard() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('username-display').textContent = currentUser || 'Admin';
            loadDashboardData();
        }
        
        // Logout
        async function logout() {
            if (sessionId) {
                try {
                    const logoutUrl = getAPIUrl('/api/admin/logout');
                    await fetch(logoutUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${sessionId}`
                        }
                    });
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
            
            sessionId = null;
            currentUser = null;
            localStorage.removeItem('admin_session');
            document.getElementById('login-page').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            if (!sessionId) {
                console.warn('loadDashboardData: No sessionId available');
                return;
            }
            
            // Load dashboard statistics
            await loadDashboardStats();
            
            // Load media files
            await loadMediaFiles();
            
            // Load pages
            try {
                console.log('Loading pages with sessionId:', sessionId.substring(0, 20) + '...');
                const apiUrl = getAPIUrl('/api/admin/pages');
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    console.error('Pages request failed:', response.status, response.statusText);
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Error data:', errorData);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    // Pages count is now handled by dashboard stats
                    if (data.data.pages) {
                        renderPagesTable(data.data.pages);
                    }
                } else {
                    console.error('Pages response not successful:', data);
                }
            } catch (error) {
                console.error('Error loading pages:', error);
            }
            
            // Load services
            try {
                const apiUrl = getAPIUrl('/api/admin/services');
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        // Services count is now handled by dashboard stats
                        if (data.data.services) {
                            renderServicesTable(data.data.services);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading services:', error);
            }
            
            // Load apps
            try {
                const apiUrl = getAPIUrl('/api/admin/apps');
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        if (data.data.apps) {
                            renderAppsTable(data.data.apps);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading apps:', error);
            }
            
            // Load content blocks
            try {
                const apiUrl = getAPIUrl('/api/admin/content');
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        if (data.data.contentBlocks) {
                            renderContentBlocksTable(data.data.contentBlocks);
                            window.allContentBlocks = data.data.contentBlocks; // Store for filtering
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading content blocks:', error);
            }
            
            // Load users
            try {
                const apiUrl = getAPIUrl('/api/admin/users');
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        if (data.data.users) {
                            renderUsersTable(data.data.users);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
            
            // Load contact messages (silent - no loading indicator)
            await loadContactMessages(false);
            
            // Load settings
            try {
                const apiUrl = getAPIUrl('/api/admin/settings');
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        populateSettingsForm(data.data);
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        // ========== DASHBOARD STATISTICS ==========
        
        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const apiUrl = getAPIUrl('/api/admin/overview');
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        renderDashboardStats(data.data);
                    }
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }
        
        // Refresh dashboard stats
        async function refreshDashboardStats() {
            await loadDashboardStats();
        }
        
        // Render dashboard statistics
        function renderDashboardStats(stats) {
            // Main stats
            document.getElementById('total-pages').textContent = stats.pages?.total || 0;
            document.getElementById('recent-pages').textContent = `${stats.pages?.recent || 0} modified recently`;
            document.getElementById('total-services').textContent = stats.services?.total || 0;
            document.getElementById('services-categories').textContent = `${Object.keys(stats.services?.byCategory || {}).length} categories`;
            document.getElementById('total-content').textContent = stats.content?.total || 0;
            document.getElementById('content-languages').textContent = `${Object.keys(stats.content?.byLanguage || {}).length} languages`;
            document.getElementById('total-users').textContent = stats.users?.total || 0;
            document.getElementById('active-users').textContent = `${stats.users?.active || 0} active`;
            
            // Contact Messages Stats
            if (stats.contact) {
                document.getElementById('total-contact').textContent = stats.contact.total || 0;
                const unreadCount = stats.contact.unread || 0;
                document.getElementById('unread-count').textContent = unreadCount;
                if (unreadCount > 0) {
                    document.getElementById('unread-contact').style.fontWeight = 'bold';
                    document.getElementById('unread-contact').style.color = '#ffeb3b';
                }
            }
            
            // Visitor Stats
            if (stats.visitors) {
                document.getElementById('total-visitors').textContent = stats.visitors.totalVisitors || 0;
                document.getElementById('total-page-views').textContent = `${stats.visitors.totalPageViews || 0} page views`;
            }
            
            // Services by Category Chart
            renderCategoryChart('services-category-chart', stats.services?.byCategory || {});
            
            // Users by Role Chart
            renderRoleChart('users-role-chart', stats.users?.byRole || {});
            
            // Content by Category Chart
            renderCategoryChart('content-category-chart', stats.content?.byCategory || {});
            
            // Content by Language Chart
            renderLanguageChart('content-language-chart', stats.content?.byLanguage || {});
            
            // Recent Activity
            renderRecentActivity(stats.recentActivity || []);
            
            // System Status
            if (stats.system) {
                const lastUpdated = new Date(stats.system.lastUpdated);
                document.getElementById('system-last-updated').textContent = lastUpdated.toLocaleString();
                document.getElementById('system-maintenance').textContent = stats.system.maintenanceMode ? 'üü° Enabled' : 'üü¢ Disabled';
                document.getElementById('system-data-files').textContent = stats.system.totalDataFiles || 0;
                document.getElementById('system-recent-logins').textContent = stats.users?.recentLogins || 0;
            }
        }
        
        // Render category chart
        function renderCategoryChart(containerId, data) {
            const container = document.getElementById(containerId);
            const entries = Object.entries(data);
            
            if (entries.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-light);">No data available</div>';
                return;
            }
            
            const total = Object.values(data).reduce((sum, val) => sum + val, 0);
            let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
            
            entries.forEach(([category, count]) => {
                const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
                html += `
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="font-weight: 600;">${category.charAt(0).toUpperCase() + category.slice(1)}</span>
                            <span style="color: var(--text-light);">${count} (${percentage}%)</span>
                        </div>
                        <div style="background: var(--bg-light); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, var(--primary), var(--accent)); height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Render role chart
        function renderRoleChart(containerId, data) {
            const container = document.getElementById(containerId);
            const entries = Object.entries(data);
            
            if (entries.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-light);">No data available</div>';
                return;
            }
            
            const roleColors = {
                'super_admin': '#dc3545',
                'admin': '#ffc107',
                'editor': '#28a745'
            };
            
            const roleNames = {
                'super_admin': 'Super Admin',
                'admin': 'Admin',
                'editor': 'Editor'
            };
            
            const total = Object.values(data).reduce((sum, val) => sum + val, 0);
            let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
            
            entries.forEach(([role, count]) => {
                const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
                const color = roleColors[role] || 'var(--primary)';
                html += `
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="font-weight: 600;">${roleNames[role] || role}</span>
                            <span style="color: var(--text-light);">${count} (${percentage}%)</span>
                        </div>
                        <div style="background: var(--bg-light); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: ${color}; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Render language chart
        function renderLanguageChart(containerId, data) {
            const container = document.getElementById(containerId);
            const entries = Object.entries(data);
            
            if (entries.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-light);">No data available</div>';
                return;
            }
            
            const languageNames = {
                'en': 'English',
                'fr': 'French',
                'es': 'Spanish',
                'de': 'German',
                'ar': 'Arabic'
            };
            
            const total = Object.values(data).reduce((sum, val) => sum + val, 0);
            let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
            
            entries.forEach(([lang, count]) => {
                const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
                html += `
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="font-weight: 600;">${languageNames[lang] || lang.toUpperCase()}</span>
                            <span style="color: var(--text-light);">${count} (${percentage}%)</span>
                        </div>
                        <div style="background: var(--bg-light); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #4facfe, #00f2fe); height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Render recent activity
        function renderRecentActivity(activities) {
            const container = document.getElementById('recent-activity-list');
            
            if (activities.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-light);">No recent activity</div>';
                return;
            }
            
            const activityIcons = {
                'page': 'üìÑ',
                'user': 'üë§',
                'service': 'üõ†Ô∏è',
                'content': '‚úèÔ∏è',
                'contact': 'üìß'
            };
            
            const activityLabels = {
                'modified': 'Modified',
                'created': 'Created',
                'deleted': 'Deleted',
                'login': 'Logged in',
                'submitted': 'Contact form submitted'
            };
            
            let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
            
            activities.forEach(activity => {
                const date = new Date(activity.timestamp);
                const timeAgo = getTimeAgo(date);
                const isUnread = activity.type === 'contact' && activity.read === false;
                html += `
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: ${isUnread ? '#fff3cd' : 'var(--bg-light)'}; border-radius: 0.5rem; ${isUnread ? 'border-left: 3px solid #ffc107;' : ''}">
                        <div style="font-size: 1.5rem;">${activityIcons[activity.type] || 'üìå'}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: ${isUnread ? 'bold' : '600'};">
                                ${activityLabels[activity.action] || activity.action} ${activity.item}
                                ${activity.type === 'contact' && activity.email ? `<span style="color: var(--text-light); font-weight: normal;"> (${activity.email})</span>` : ''}
                            </div>
                            <div style="font-size: 0.875rem; color: var(--text-light);">${timeAgo}</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Get time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            return date.toLocaleDateString();
        }
        
        // ========== MEDIA MANAGEMENT ==========
        let allMediaFiles = [];
        
        // Load media files
        async function loadMediaFiles() {
            try {
                const apiUrl = getAPIUrl('/api/admin/media');
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        allMediaFiles = data.data;
                        renderMediaGrid(data.data);
                        document.getElementById('media-loading').style.display = 'none';
                        document.getElementById('media-content').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading media files:', error);
                document.getElementById('media-loading').innerHTML = `<div class="alert error">Error loading media: ${error.message}</div>`;
            }
        }
        
        // Handle media upload
        async function handleMediaUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('/api/admin/media-upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${sessionId}`
                            // Don't set Content-Type - browser will set it with boundary
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        console.log('File uploaded:', data.data.filename);
                    } else {
                        console.error('Upload failed:', data.message);
                        alert(`Failed to upload ${file.name}: ${data.message}`);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert(`Error uploading ${file.name}: ${error.message}`);
                }
            }
            
            // Reset input and reload media
            event.target.value = '';
            await loadMediaFiles();
        }
        
        // Filter media by type
        function filterMedia() {
            const filterType = document.getElementById('media-type-filter').value;
            const filtered = filterType === 'all' 
                ? allMediaFiles 
                : allMediaFiles.filter(file => file.type === filterType);
            renderMediaGrid(filtered);
        }
        
        // Render media grid
        function renderMediaGrid(files) {
            const grid = document.getElementById('media-grid');
            
            if (files.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--text-light);">No media files found</div>';
                return;
            }
            
            let html = '';
            files.forEach(file => {
                const sizeKB = (file.size / 1024).toFixed(1);
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                const sizeStr = file.size > 1024 * 1024 ? `${sizeMB} MB` : `${sizeKB} KB`;
                
                html += `
                    <div style="background: white; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="position: relative; padding-top: 100%; background: var(--bg-light);">
                            ${file.type === 'image' ? `
                                <img src="${file.url}" alt="${file.filename}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">
                            ` : file.type === 'video' ? `
                                <video src="${file.url}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" muted></video>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem;">üé¨</div>
                            ` : file.type === 'audio' ? `
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem;">üéµ</div>
                            ` : `
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem;">üìÑ</div>
                            `}
                        </div>
                        <div style="padding: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.filename}">${file.filename}</div>
                            <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.5rem;">
                                ${file.type.toUpperCase()} ‚Ä¢ ${sizeStr}
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-sm" onclick="copyMediaUrl('${file.url}')" style="flex: 1;">Copy URL</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteMediaFile('${file.filename}')" style="flex: 1;">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
        
        // Copy media URL
        function copyMediaUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert('URL copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy URL');
            });
        }
        
        // Delete media file
        async function deleteMediaFile(filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/media/${encodeURIComponent(filename)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    await loadMediaFiles();
                } else {
                    alert(`Failed to delete file: ${data.message}`);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert(`Error deleting file: ${error.message}`);
            }
        }
        
        // Render pages table
        function renderPagesTable(pages) {
            const tbody = document.getElementById('pages-table-body');
            
            if (pages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No pages found</td></tr>';
                return;
            }
            
            tbody.innerHTML = pages.map(page => `
                <tr>
                    <td><strong>${page.name}</strong></td>
                    <td><a href="${page.url}" target="_blank">${page.url}</a></td>
                    <td>${formatBytes(page.size)}</td>
                    <td>${formatDate(page.modified)}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-secondary" onclick="viewPage('${page.name}')" title="View">üëÅÔ∏è</button>
                            <button class="btn btn-sm btn-primary" onclick="editPage('${page.name}')" title="Edit">‚úèÔ∏è</button>
                            <button class="btn btn-sm" onclick="previewPageInBrowser('${page.url}')" title="Preview" style="background: var(--success);">üîó</button>
                            ${page.name !== 'admin.html' && page.name !== 'index.html' ? `<button class="btn btn-sm" onclick="deletePage('${page.name}')" title="Delete" style="background: var(--error);">üóëÔ∏è</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // Menu navigation
        document.querySelectorAll('.menu-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.getAttribute('data-section');
                
                // Update active menu
                document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                // Show section
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                document.getElementById(section).classList.add('active');
            });
        });
        
        // Helper functions
        function showAlert(type, message) {
            const alertDiv = document.getElementById('login-alert');
            alertDiv.className = `alert ${type}`;
            alertDiv.textContent = message;
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        let currentEditingPage = null;
        let isCreatingNewPage = false;
        
        // Show create page modal
        function showCreatePageModal() {
            isCreatingNewPage = true;
            currentEditingPage = null;
            document.getElementById('modal-title').textContent = 'Create New Page';
            document.getElementById('page-name-input').value = '';
            document.getElementById('page-name-input').disabled = false;
            document.getElementById('page-content-input').value = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Page - Paxi iTechnologies</title>
</head>
<body>
    <h1>New Page</h1>
    <p>Start editing your page content here...</p>
</body>
</html>`;
            document.getElementById('page-editor-alert').innerHTML = '';
            document.getElementById('page-editor-modal').style.display = 'flex';
        }
        
        // View page (read-only)
        async function viewPage(pageName) {
            try {
                const response = await fetch(`/api/admin/pages/${encodeURIComponent(pageName)}`, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert('Error loading page: ' + (error.message || 'Unknown error'));
                    return;
                }
                
                const data = await response.json();
                if (data.success && data.data) {
                    isCreatingNewPage = false;
                    currentEditingPage = pageName;
                    document.getElementById('modal-title').textContent = `View: ${pageName}`;
                    document.getElementById('page-name-input').value = pageName;
                    document.getElementById('page-name-input').disabled = true;
                    document.getElementById('page-content-input').value = data.data.content;
                    document.getElementById('page-content-input').readOnly = true;
                    document.getElementById('page-editor-alert').innerHTML = '';
                    document.getElementById('page-editor-modal').style.display = 'flex';
                }
            } catch (error) {
                alert('Error loading page: ' + error.message);
            }
        }
        
        // Edit page
        async function editPage(pageName) {
            try {
                const response = await fetch(`/api/admin/pages/${encodeURIComponent(pageName)}`, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert('Error loading page: ' + (error.message || 'Unknown error'));
                    return;
                }
                
                const data = await response.json();
                if (data.success && data.data) {
                    isCreatingNewPage = false;
                    currentEditingPage = pageName;
                    document.getElementById('modal-title').textContent = `Edit: ${pageName}`;
                    document.getElementById('page-name-input').value = pageName;
                    document.getElementById('page-name-input').disabled = true;
                    document.getElementById('page-content-input').value = data.data.content;
                    document.getElementById('page-content-input').readOnly = false;
                    document.getElementById('page-editor-alert').innerHTML = '';
                    document.getElementById('page-editor-modal').style.display = 'flex';
                }
            } catch (error) {
                alert('Error loading page: ' + error.message);
            }
        }
        
        // Close page editor
        function closePageEditor() {
            document.getElementById('page-editor-modal').style.display = 'none';
            currentEditingPage = null;
            isCreatingNewPage = false;
            document.getElementById('page-content-input').readOnly = false;
        }
        
        // Save page
        async function savePage() {
            const pageName = document.getElementById('page-name-input').value.trim();
            const pageContent = document.getElementById('page-content-input').value.trim();
            const alertDiv = document.getElementById('page-editor-alert');
            
            if (!pageName) {
                alertDiv.innerHTML = '<div class="alert error">Page name is required</div>';
                return;
            }
            
            if (!pageContent) {
                alertDiv.innerHTML = '<div class="alert error">Page content is required</div>';
                return;
            }
            
            // Ensure .html extension
            const finalPageName = pageName.endsWith('.html') ? pageName : pageName + '.html';
            
            try {
                const url = isCreatingNewPage 
                    ? '/api/admin/pages'
                    : `/api/admin/pages/${encodeURIComponent(currentEditingPage)}`;
                const method = isCreatingNewPage ? 'POST' : 'PUT';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: finalPageName,
                        content: pageContent
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alertDiv.innerHTML = '<div class="alert success">‚úÖ Page saved successfully!</div>';
                    setTimeout(() => {
                        closePageEditor();
                        loadDashboardData(); // Refresh pages list
                    }, 1000);
                } else {
                    alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${data.message || 'Failed to save page'}</div>`;
                }
            } catch (error) {
                alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Delete page
        async function deletePage(pageName) {
            if (!confirm(`Are you sure you want to delete "${pageName}"?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/pages/${encodeURIComponent(pageName)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert('‚úÖ Page deleted successfully!');
                    loadDashboardData(); // Refresh pages list
                } else {
                    alert('‚ùå Error: ' + (data.message || 'Failed to delete page'));
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        // Preview page in modal
        function previewPage() {
            const content = document.getElementById('page-content-input').value;
            const previewFrame = document.getElementById('page-preview-frame');
            const previewModal = document.getElementById('page-preview-modal');
            
            if (!content.trim()) {
                alert('No content to preview');
                return;
            }
            
            // Create blob URL for preview
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            previewFrame.src = url;
            previewModal.style.display = 'flex';
            
            // Clean up blob URL when modal closes
            previewModal.addEventListener('click', function cleanup(e) {
                if (e.target === previewModal) {
                    URL.revokeObjectURL(url);
                    previewModal.removeEventListener('click', cleanup);
                }
            });
        }
        
        // Close preview
        function closePreview() {
            const previewModal = document.getElementById('page-preview-modal');
            const previewFrame = document.getElementById('page-preview-frame');
            previewModal.style.display = 'none';
            previewFrame.src = 'about:blank';
        }
        
        // Preview page in browser
        function previewPageInBrowser(url) {
            window.open(url, '_blank');
        }
        
        // ========== MEDIA PICKER FOR PAGE EDITOR ==========
        let mediaPickerFiles = [];
        
        // Show media picker
        async function showMediaPicker() {
            document.getElementById('media-picker-modal').style.display = 'flex';
            await loadMediaPickerFiles();
        }
        
        // Close media picker
        function closeMediaPicker() {
            document.getElementById('media-picker-modal').style.display = 'none';
        }
        
        // Load media files for picker
        async function loadMediaPickerFiles() {
            try {
                const apiUrl = getAPIUrl('/api/admin/media');
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        mediaPickerFiles = data.data;
                        renderMediaPickerGrid(data.data);
                    }
                }
            } catch (error) {
                console.error('Error loading media for picker:', error);
            }
        }
        
        // Filter media picker
        function filterMediaPicker() {
            const filterType = document.getElementById('media-picker-filter').value;
            const filtered = filterType === 'all' 
                ? mediaPickerFiles 
                : mediaPickerFiles.filter(file => file.type === filterType);
            renderMediaPickerGrid(filtered);
        }
        
        // Render media picker grid
        function renderMediaPickerGrid(files) {
            const grid = document.getElementById('media-picker-grid');
            
            if (files.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--text-light);">No media files found. Upload some media first!</div>';
                return;
            }
            
            let html = '';
            files.forEach(file => {
                html += `
                    <div style="background: white; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;" onclick="insertMediaIntoPage('${file.url}', '${file.type}', '${file.filename.replace(/'/g, "\\'")}')" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="position: relative; padding-top: 100%; background: var(--bg-light);">
                            ${file.type === 'image' ? `
                                <img src="${file.url}" alt="${file.filename}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">
                            ` : file.type === 'video' ? `
                                <video src="${file.url}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" muted></video>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem;">üé¨</div>
                            ` : `
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem;">üìÑ</div>
                            `}
                        </div>
                        <div style="padding: 0.5rem; font-size: 0.75rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.filename}">${file.filename}</div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
        
        // Insert media into page content
        function insertMediaIntoPage(url, type, filename) {
            const textarea = document.getElementById('page-content-input');
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);
            
            let insertCode = '';
            if (type === 'image') {
                insertCode = `\n<img src="${url}" alt="${filename}" style="max-width: 100%; height: auto;">\n`;
            } else if (type === 'video') {
                insertCode = `\n<video src="${url}" controls style="max-width: 100%; height: auto;"></video>\n`;
            } else {
                insertCode = `\n<a href="${url}" target="_blank">${filename}</a>\n`;
            }
            
            textarea.value = textBefore + insertCode + textAfter;
            textarea.focus();
            textarea.setSelectionRange(cursorPos + insertCode.length, cursorPos + insertCode.length);
            
            closeMediaPicker();
        }
        
        // Handle media upload from picker
        async function handleMediaPickerUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('/api/admin/media-upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${sessionId}`
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        console.log('File uploaded:', data.data.filename);
                    } else {
                        alert(`Failed to upload ${file.name}: ${data.message}`);
                    }
                } catch (error) {
                    alert(`Error uploading ${file.name}: ${error.message}`);
                }
            }
            
            event.target.value = '';
            await loadMediaPickerFiles();
        }
        
        // Format HTML (basic indentation)
        function formatHTML() {
            const textarea = document.getElementById('page-content-input');
            const content = textarea.value;
            
            // Simple HTML formatting (basic indentation)
            let formatted = content
                .replace(/></g, '>\n<')
                .split('\n')
                .map(line => {
                    const trimmed = line.trim();
                    if (!trimmed) return '';
                    // Add indentation based on closing tags
                    if (trimmed.startsWith('</')) {
                        return trimmed;
                    }
                    return trimmed;
                })
                .filter(line => line)
                .join('\n');
            
            textarea.value = formatted;
        }
        
        // ========== SERVICES MANAGEMENT ==========
        let currentEditingService = null;
        let isCreatingNewService = false;
        
        // Render services table
        function renderServicesTable(services) {
            const tbody = document.getElementById('services-table-body');
            
            if (services.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No services found</td></tr>';
                return;
            }
            
            tbody.innerHTML = services.map(service => `
                <tr>
                    <td style="font-size: 1.5rem; text-align: center;">${service.icon || 'üìã'}</td>
                    <td><strong>${service.name}</strong></td>
                    <td><span style="background: var(--bg-light); padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.875rem;">${service.category || 'general'}</span></td>
                    <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${service.description || ''}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-secondary" onclick="viewService(${service.id})" title="View">üëÅÔ∏è</button>
                            <button class="btn btn-sm btn-primary" onclick="editService(${service.id})" title="Edit">‚úèÔ∏è</button>
                            <button class="btn btn-sm" onclick="deleteService(${service.id})" title="Delete" style="background: var(--error);">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // Show create service modal
        function showCreateServiceModal() {
            isCreatingNewService = true;
            currentEditingService = null;
            document.getElementById('service-modal-title').textContent = 'Create New Service';
            document.getElementById('service-name-input').value = '';
            document.getElementById('service-icon-input').value = 'üìã';
            document.getElementById('service-category-input').value = 'general';
            document.getElementById('service-description-input').value = '';
            document.getElementById('service-details-input').value = '';
            document.getElementById('service-extra-input').value = '';
            document.getElementById('service-editor-alert').innerHTML = '';
            document.getElementById('service-editor-modal').style.display = 'flex';
        }
        
        // View service (read-only)
        async function viewService(serviceId) {
            try {
                const response = await fetch(`/api/admin/services/${serviceId}`, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert('Error loading service: ' + (error.message || 'Unknown error'));
                    return;
                }
                
                const data = await response.json();
                if (data.success && data.data) {
                    populateServiceForm(data.data, true);
                    document.getElementById('service-modal-title').textContent = `View: ${data.data.name}`;
                    document.getElementById('service-editor-modal').style.display = 'flex';
                }
            } catch (error) {
                alert('Error loading service: ' + error.message);
            }
        }
        
        // Edit service
        async function editService(serviceId) {
            try {
                const response = await fetch(`/api/admin/services/${serviceId}`, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert('Error loading service: ' + (error.message || 'Unknown error'));
                    return;
                }
                
                const data = await response.json();
                if (data.success && data.data) {
                    isCreatingNewService = false;
                    currentEditingService = serviceId;
                    populateServiceForm(data.data, false);
                    document.getElementById('service-modal-title').textContent = `Edit: ${data.data.name}`;
                    document.getElementById('service-editor-modal').style.display = 'flex';
                }
            } catch (error) {
                alert('Error loading service: ' + error.message);
            }
        }
        
        // Populate service form
        function populateServiceForm(service, readOnly) {
            document.getElementById('service-name-input').value = service.name || '';
            document.getElementById('service-icon-input').value = service.icon || 'üìã';
            document.getElementById('service-category-input').value = service.category || 'general';
            document.getElementById('service-description-input').value = service.description || '';
            document.getElementById('service-details-input').value = (service.details || []).join('\n');
            
            // Extract extra fields (certifications, technologies, etc.)
            const extraFields = {};
            if (service.certifications) extraFields.certifications = service.certifications;
            if (service.technologies) extraFields.technologies = service.technologies;
            if (service.platforms) extraFields.platforms = service.platforms;
            if (service.experience) extraFields.experience = service.experience;
            if (service.methodology) extraFields.methodology = service.methodology;
            
            document.getElementById('service-extra-input').value = Object.keys(extraFields).length > 0 
                ? JSON.stringify(extraFields, null, 2) 
                : '';
            
            // Set readonly state
            document.getElementById('service-name-input').readOnly = readOnly;
            document.getElementById('service-icon-input').readOnly = readOnly;
            document.getElementById('service-category-input').disabled = readOnly;
            document.getElementById('service-description-input').readOnly = readOnly;
            document.getElementById('service-details-input').readOnly = readOnly;
            document.getElementById('service-extra-input').readOnly = readOnly;
        }
        
        // Close service editor
        function closeServiceEditor() {
            document.getElementById('service-editor-modal').style.display = 'none';
            currentEditingService = null;
            isCreatingNewService = false;
            // Reset readonly states
            document.getElementById('service-name-input').readOnly = false;
            document.getElementById('service-icon-input').readOnly = false;
            document.getElementById('service-category-input').disabled = false;
            document.getElementById('service-description-input').readOnly = false;
            document.getElementById('service-details-input').readOnly = false;
            document.getElementById('service-extra-input').readOnly = false;
        }
        
        // Save service
        async function saveService() {
            const name = document.getElementById('service-name-input').value.trim();
            const icon = document.getElementById('service-icon-input').value.trim();
            const category = document.getElementById('service-category-input').value;
            const description = document.getElementById('service-description-input').value.trim();
            const detailsText = document.getElementById('service-details-input').value.trim();
            const extraText = document.getElementById('service-extra-input').value.trim();
            const alertDiv = document.getElementById('service-editor-alert');
            
            if (!name || !description) {
                alertDiv.innerHTML = '<div class="alert error">Service name and description are required</div>';
                return;
            }
            
            // Parse details (split by newline)
            const details = detailsText ? detailsText.split('\n').filter(d => d.trim()) : [];
            
            // Parse extra fields
            let extraFields = {};
            if (extraText) {
                try {
                    extraFields = JSON.parse(extraText);
                } catch (e) {
                    alertDiv.innerHTML = '<div class="alert error">Invalid JSON in extra fields</div>';
                    return;
                }
            }
            
            const serviceData = {
                name,
                icon: icon || 'üìã',
                category,
                description,
                details,
                ...extraFields
            };
            
            try {
                const url = isCreatingNewService 
                    ? '/api/admin/services'
                    : `/api/admin/services/${currentEditingService}`;
                const method = isCreatingNewService ? 'POST' : 'PUT';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(serviceData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alertDiv.innerHTML = '<div class="alert success">‚úÖ Service saved successfully!</div>';
                    setTimeout(() => {
                        closeServiceEditor();
                        loadDashboardData(); // Refresh services list
                    }, 1000);
                } else {
                    alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${data.message || 'Failed to save service'}</div>`;
                }
            } catch (error) {
                alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Delete service
        async function deleteService(serviceId) {
            if (!confirm(`Are you sure you want to delete this service?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/services/${serviceId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert('‚úÖ Service deleted successfully!');
                    loadDashboardData(); // Refresh services list
                } else {
                    alert('‚ùå Error: ' + (data.message || 'Failed to delete service'));
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        // ========== APPS MANAGEMENT ==========
        let currentEditingApp = null;
        let isCreatingNewApp = false;
        
        // Render apps table
        function renderAppsTable(apps) {
            const tbody = document.getElementById('apps-table-body');
            
            if (apps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No apps found</td></tr>';
                return;
            }
            
            tbody.innerHTML = apps.map(app => `
                <tr>
                    <td style="font-size: 1.5rem; text-align: center;">${app.icon || 'üöÄ'}</td>
                    <td><strong>${app.name}</strong></td>
                    <td>
                        <span style="background: ${app.status === 'live' ? 'linear-gradient(135deg, #006d77 0%, #83c5be 100%)' : 'linear-gradient(135deg, #e29578 0%, #ffb88c 100%)'}; color: white; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.875rem; text-transform: uppercase;">
                            ${app.status === 'live' ? 'Live' : 'Coming Soon'}
                        </span>
                    </td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${app.link ? `<a href="${app.link}" target="_blank" style="color: var(--primary);">${app.link}</a>` : '<span style="color: var(--text-light);">No link</span>'}
                    </td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${app.description || ''}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-primary" onclick="editApp(${app.id})" title="Edit">‚úèÔ∏è</button>
                            <button class="btn btn-sm" onclick="deleteApp(${app.id})" title="Delete" style="background: var(--error);">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // Show create app modal
        function showCreateAppModal() {
            currentEditingApp = null;
            isCreatingNewApp = true;
            document.getElementById('app-modal-title').textContent = 'Create New App';
            document.getElementById('app-name-input').value = '';
            document.getElementById('app-icon-input').value = 'üöÄ';
            document.getElementById('app-description-input').value = '';
            document.getElementById('app-status-input').value = 'coming-soon';
            document.getElementById('app-link-input').value = '';
            document.getElementById('app-editor-alert').innerHTML = '';
            document.getElementById('app-editor-modal').style.display = 'flex';
        }
        
        // Edit app
        async function editApp(appId) {
            try {
                const apiUrl = getAPIUrl(`/api/admin/apps/${appId}`);
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        const app = data.data;
                        currentEditingApp = appId;
                        isCreatingNewApp = false;
                        document.getElementById('app-modal-title').textContent = 'Edit App';
                        document.getElementById('app-name-input').value = app.name || '';
                        document.getElementById('app-icon-input').value = app.icon || 'üöÄ';
                        document.getElementById('app-description-input').value = app.description || '';
                        document.getElementById('app-status-input').value = app.status || 'coming-soon';
                        document.getElementById('app-link-input').value = app.link || '';
                        document.getElementById('app-editor-alert').innerHTML = '';
                        document.getElementById('app-editor-modal').style.display = 'flex';
                    }
                }
            } catch (error) {
                alert('‚ùå Error loading app: ' + error.message);
            }
        }
        
        // Close app editor
        function closeAppEditor() {
            document.getElementById('app-editor-modal').style.display = 'none';
            currentEditingApp = null;
            isCreatingNewApp = false;
        }
        
        // Save app
        async function saveApp() {
            const alertDiv = document.getElementById('app-editor-alert');
            const name = document.getElementById('app-name-input').value.trim();
            const icon = document.getElementById('app-icon-input').value.trim();
            const description = document.getElementById('app-description-input').value.trim();
            const status = document.getElementById('app-status-input').value;
            const link = document.getElementById('app-link-input').value.trim();
            
            if (!name || !description) {
                alertDiv.innerHTML = '<div class="alert error">‚ùå Name and description are required</div>';
                return;
            }
            
            if (status === 'live' && !link) {
                alertDiv.innerHTML = '<div class="alert error">‚ùå Link is required for Live apps</div>';
                return;
            }
            
            const appData = {
                name,
                icon: icon || 'üöÄ',
                description,
                status,
                link: status === 'live' ? link : ''
            };
            
            try {
                const url = isCreatingNewApp 
                    ? '/api/admin/apps'
                    : `/api/admin/apps/${currentEditingApp}`;
                const method = isCreatingNewApp ? 'POST' : 'PUT';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(appData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alertDiv.innerHTML = '<div class="alert success">‚úÖ App saved successfully!</div>';
                    setTimeout(() => {
                        closeAppEditor();
                        loadDashboardData(); // Refresh apps list
                    }, 1000);
                } else {
                    alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${data.message || 'Failed to save app'}</div>`;
                }
            } catch (error) {
                alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Delete app
        async function deleteApp(appId) {
            if (!confirm(`Are you sure you want to delete this app?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/apps/${appId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert('‚úÖ App deleted successfully!');
                    loadDashboardData(); // Refresh apps list
                } else {
                    alert('‚ùå Error: ' + (data.message || 'Failed to delete app'));
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        // ========== CONTENT BLOCKS MANAGEMENT ==========
        let currentEditingContent = null;
        let isCreatingNewContent = false;
        let allContentBlocks = [];
        
        // Render content blocks table
        function renderContentBlocksTable(contentBlocks) {
            const tbody = document.getElementById('content-table-body');
            allContentBlocks = contentBlocks; // Store for filtering
            
            if (contentBlocks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No content blocks found</td></tr>';
                return;
            }
            
            tbody.innerHTML = contentBlocks.map(block => {
                const languages = Object.keys(block.content || {}).join(', ') || 'none';
                return `
                    <tr>
                        <td><strong><code>${block.key}</code></strong></td>
                        <td><span style="background: var(--bg-light); padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.875rem;">${block.type || 'text'}</span></td>
                        <td><span style="background: var(--bg-light); padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.875rem;">${block.category || 'general'}</span></td>
                        <td>${languages}</td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${block.description || '-'}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-sm btn-secondary" onclick="viewContentBlock(${block.id})" title="View">üëÅÔ∏è</button>
                                <button class="btn btn-sm btn-primary" onclick="editContentBlock(${block.id})" title="Edit">‚úèÔ∏è</button>
                                <button class="btn btn-sm" onclick="deleteContentBlock(${block.id})" title="Delete" style="background: var(--error);">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Filter content blocks by category
        function filterContentBlocks() {
            const categoryFilter = document.getElementById('content-category-filter').value;
            const filtered = categoryFilter 
                ? allContentBlocks.filter(block => block.category === categoryFilter)
                : allContentBlocks;
            renderContentBlocksTable(filtered);
        }
        
        // Show create content modal
        function showCreateContentModal() {
            isCreatingNewContent = true;
            currentEditingContent = null;
            document.getElementById('content-modal-title').textContent = 'Create New Content Block';
            document.getElementById('content-key-input').value = '';
            document.getElementById('content-key-input').disabled = false;
            document.getElementById('content-type-input').value = 'text';
            document.getElementById('content-category-input').value = 'general';
            document.getElementById('content-description-input').value = '';
            document.getElementById('content-en-input').value = '';
            document.getElementById('content-fr-input').value = '';
            document.getElementById('content-editor-alert').innerHTML = '';
            document.getElementById('content-editor-modal').style.display = 'flex';
        }
        
        // View content block (read-only)
        async function viewContentBlock(contentId) {
            try {
                const response = await fetch(`/api/admin/content/${contentId}`, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert('Error loading content block: ' + (error.message || 'Unknown error'));
                    return;
                }
                
                const data = await response.json();
                if (data.success && data.data) {
                    populateContentForm(data.data, true);
                    document.getElementById('content-modal-title').textContent = `View: ${data.data.key}`;
                    document.getElementById('content-editor-modal').style.display = 'flex';
                }
            } catch (error) {
                alert('Error loading content block: ' + error.message);
            }
        }
        
        // Edit content block
        async function editContentBlock(contentId) {
            try {
                const response = await fetch(`/api/admin/content/${contentId}`, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert('Error loading content block: ' + (error.message || 'Unknown error'));
                    return;
                }
                
                const data = await response.json();
                if (data.success && data.data) {
                    isCreatingNewContent = false;
                    currentEditingContent = contentId;
                    populateContentForm(data.data, false);
                    document.getElementById('content-modal-title').textContent = `Edit: ${data.data.key}`;
                    document.getElementById('content-editor-modal').style.display = 'flex';
                }
            } catch (error) {
                alert('Error loading content block: ' + error.message);
            }
        }
        
        // Populate content form
        function populateContentForm(contentBlock, readOnly) {
            document.getElementById('content-key-input').value = contentBlock.key || '';
            document.getElementById('content-type-input').value = contentBlock.type || 'text';
            document.getElementById('content-category-input').value = contentBlock.category || 'general';
            document.getElementById('content-description-input').value = contentBlock.description || '';
            
            // Populate language content
            const content = contentBlock.content || {};
            document.getElementById('content-en-input').value = content.en || '';
            document.getElementById('content-fr-input').value = content.fr || '';
            
            // Set readonly state
            document.getElementById('content-key-input').readOnly = readOnly;
            document.getElementById('content-type-input').disabled = readOnly;
            document.getElementById('content-category-input').disabled = readOnly;
            document.getElementById('content-description-input').readOnly = readOnly;
            document.getElementById('content-en-input').readOnly = readOnly;
            document.getElementById('content-fr-input').readOnly = readOnly;
        }
        
        // Close content editor
        function closeContentEditor() {
            document.getElementById('content-editor-modal').style.display = 'none';
            currentEditingContent = null;
            isCreatingNewContent = false;
            // Reset readonly states
            document.getElementById('content-key-input').readOnly = false;
            document.getElementById('content-type-input').disabled = false;
            document.getElementById('content-category-input').disabled = false;
            document.getElementById('content-description-input').readOnly = false;
            document.getElementById('content-en-input').readOnly = false;
            document.getElementById('content-fr-input').readOnly = false;
        }
        
        // Save content block
        async function saveContentBlock() {
            const key = document.getElementById('content-key-input').value.trim();
            const type = document.getElementById('content-type-input').value;
            const category = document.getElementById('content-category-input').value;
            const description = document.getElementById('content-description-input').value.trim();
            const contentEn = document.getElementById('content-en-input').value.trim();
            const contentFr = document.getElementById('content-fr-input').value.trim();
            const alertDiv = document.getElementById('content-editor-alert');
            
            if (!key || !contentEn || !contentFr) {
                alertDiv.innerHTML = '<div class="alert error">Content key, English content, and French content are required</div>';
                return;
            }
            
            const contentData = {
                key,
                type,
                category,
                description,
                content: {
                    en: contentEn,
                    fr: contentFr
                }
            };
            
            try {
                const url = isCreatingNewContent 
                    ? '/api/admin/content'
                    : `/api/admin/content/${currentEditingContent}`;
                const method = isCreatingNewContent ? 'POST' : 'PUT';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(contentData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alertDiv.innerHTML = '<div class="alert success">‚úÖ Content block saved successfully!</div>';
                    setTimeout(() => {
                        closeContentEditor();
                        loadDashboardData(); // Refresh content blocks list
                    }, 1000);
                } else {
                    alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${data.message || 'Failed to save content block'}</div>`;
                }
            } catch (error) {
                alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Delete content block
        async function deleteContentBlock(contentId) {
            if (!confirm(`Are you sure you want to delete this content block?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/content/${contentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert('‚úÖ Content block deleted successfully!');
                    loadDashboardData(); // Refresh content blocks list
                } else {
                    alert('‚ùå Error: ' + (data.message || 'Failed to delete content block'));
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        // ========== USER MANAGEMENT ==========
        let currentEditingUser = null;
        let isCreatingNewUser = false;
        
        // Render users table
        function renderUsersTable(users) {
            const tbody = document.getElementById('users-table-body');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No users found</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Never';
                const roleBadge = user.role === 'super_admin' ? 'üî¥ Super Admin' : user.role === 'admin' ? 'üü° Admin' : 'üü¢ Editor';
                const statusBadge = user.status === 'active' ? 'üü¢ Active' : 'üî¥ Inactive';
                return `
                    <tr>
                        <td><strong>${user.username}</strong></td>
                        <td>${user.email}</td>
                        <td>${roleBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${lastLogin}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-sm btn-primary" onclick="editUser(${user.id})" title="Edit">‚úèÔ∏è</button>
                                <button class="btn btn-sm" onclick="deleteUser(${user.id})" title="Delete" style="background: var(--error);">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Show create user modal
        function showCreateUserModal() {
            isCreatingNewUser = true;
            currentEditingUser = null;
            document.getElementById('user-modal-title').textContent = 'Create New User';
            document.getElementById('user-username-input').value = '';
            document.getElementById('user-username-input').disabled = false;
            document.getElementById('user-email-input').value = '';
            document.getElementById('user-role-input').value = 'admin';
            document.getElementById('user-status-input').value = 'active';
            document.getElementById('user-password-input').value = '';
            document.getElementById('user-password-input').required = true;
            document.getElementById('user-password-label').textContent = 'Password *';
            document.getElementById('user-editor-alert').innerHTML = '';
            document.getElementById('user-editor-modal').style.display = 'flex';
        }
        
        // Edit user
        async function editUser(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert('Error loading user: ' + (error.message || 'Unknown error'));
                    return;
                }
                
                const data = await response.json();
                if (data.success && data.data) {
                    isCreatingNewUser = false;
                    currentEditingUser = userId;
                    populateUserForm(data.data);
                    document.getElementById('user-modal-title').textContent = `Edit: ${data.data.username}`;
                    document.getElementById('user-password-input').required = false;
                    document.getElementById('user-password-label').textContent = 'Password (leave blank to keep current)';
                    document.getElementById('user-editor-modal').style.display = 'flex';
                }
            } catch (error) {
                alert('Error loading user: ' + error.message);
            }
        }
        
        // Populate user form
        function populateUserForm(user) {
            document.getElementById('user-username-input').value = user.username || '';
            document.getElementById('user-email-input').value = user.email || '';
            document.getElementById('user-role-input').value = user.role || 'admin';
            document.getElementById('user-status-input').value = user.status || 'active';
            document.getElementById('user-password-input').value = '';
        }
        
        // Close user editor
        function closeUserEditor() {
            document.getElementById('user-editor-modal').style.display = 'none';
            currentEditingUser = null;
            isCreatingNewUser = false;
        }
        
        // Save user
        async function saveUser() {
            const username = document.getElementById('user-username-input').value.trim();
            const email = document.getElementById('user-email-input').value.trim();
            const role = document.getElementById('user-role-input').value;
            const status = document.getElementById('user-status-input').value;
            const password = document.getElementById('user-password-input').value;
            const alertDiv = document.getElementById('user-editor-alert');
            
            if (!username || !email) {
                alertDiv.innerHTML = '<div class="alert error">Username and email are required</div>';
                return;
            }
            
            if (isCreatingNewUser && !password) {
                alertDiv.innerHTML = '<div class="alert error">Password is required for new users</div>';
                return;
            }
            
            if (password && password.length < 6) {
                alertDiv.innerHTML = '<div class="alert error">Password must be at least 6 characters</div>';
                return;
            }
            
            const userData = {
                username,
                email,
                role,
                status
            };
            
            if (password) {
                userData.password = password;
            }
            
            try {
                const url = isCreatingNewUser 
                    ? '/api/admin/users'
                    : `/api/admin/users/${currentEditingUser}`;
                const method = isCreatingNewUser ? 'POST' : 'PUT';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alertDiv.innerHTML = '<div class="alert success">‚úÖ User saved successfully!</div>';
                    setTimeout(() => {
                        closeUserEditor();
                        loadDashboardData(); // Refresh users list
                    }, 1000);
                } else {
                    alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${data.message || 'Failed to save user'}</div>`;
                }
            } catch (error) {
                alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Delete user
        async function deleteUser(userId) {
            if (!confirm(`Are you sure you want to delete this user?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert('‚úÖ User deleted successfully!');
                    loadDashboardData(); // Refresh users list
                } else {
                    alert('‚ùå Error: ' + (data.message || 'Failed to delete user'));
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        // ========== SETTINGS MANAGEMENT ==========
        
        // Populate settings form
        function populateSettingsForm(settings) {
            // Site information
            if (settings.site) {
                document.getElementById('setting-site-name').value = settings.site.name || '';
                document.getElementById('setting-site-domain').value = settings.site.domain || '';
                document.getElementById('setting-site-email').value = settings.site.email || '';
                document.getElementById('setting-site-phone').value = settings.site.phone || '';
                document.getElementById('setting-site-address').value = settings.site.address || '';
            }
            
            // SEO settings
            if (settings.seo) {
                document.getElementById('setting-seo-title').value = settings.seo.defaultTitle || '';
                document.getElementById('setting-seo-description').value = settings.seo.defaultDescription || '';
                document.getElementById('setting-seo-keywords').value = settings.seo.defaultKeywords || '';
            }
            
            // Social media
            if (settings.social) {
                document.getElementById('setting-social-facebook').value = settings.social.facebook || '';
                document.getElementById('setting-social-twitter').value = settings.social.twitter || '';
                document.getElementById('setting-social-linkedin').value = settings.social.linkedin || '';
                document.getElementById('setting-social-instagram').value = settings.social.instagram || '';
            }
            
            // Features
            if (settings.features) {
                document.getElementById('setting-feature-maintenance').checked = settings.features.maintenanceMode || false;
                document.getElementById('setting-feature-registration').checked = settings.features.allowRegistration || false;
                document.getElementById('setting-feature-comments').checked = settings.features.enableComments || false;
            }
            
            // Show settings form
            document.getElementById('settings-loading').style.display = 'none';
            document.getElementById('settings-content').style.display = 'block';
        }
        
        // Reset settings form
        function resetSettingsForm() {
            loadDashboardData(); // Reload settings
        }
        
        // Handle settings form submission
        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const settingsData = {
                site: {
                    name: document.getElementById('setting-site-name').value.trim(),
                    domain: document.getElementById('setting-site-domain').value.trim(),
                    email: document.getElementById('setting-site-email').value.trim(),
                    phone: document.getElementById('setting-site-phone').value.trim(),
                    address: document.getElementById('setting-site-address').value.trim()
                },
                seo: {
                    defaultTitle: document.getElementById('setting-seo-title').value.trim(),
                    defaultDescription: document.getElementById('setting-seo-description').value.trim(),
                    defaultKeywords: document.getElementById('setting-seo-keywords').value.trim()
                },
                social: {
                    facebook: document.getElementById('setting-social-facebook').value.trim(),
                    twitter: document.getElementById('setting-social-twitter').value.trim(),
                    linkedin: document.getElementById('setting-social-linkedin').value.trim(),
                    instagram: document.getElementById('setting-social-instagram').value.trim()
                },
                features: {
                    maintenanceMode: document.getElementById('setting-feature-maintenance').checked,
                    allowRegistration: document.getElementById('setting-feature-registration').checked,
                    enableComments: document.getElementById('setting-feature-comments').checked
                }
            };
            
            const alertDiv = document.getElementById('settings-alert');
            
            try {
                const response = await fetch('/api/admin/settings', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settingsData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alertDiv.innerHTML = '<div class="alert success">‚úÖ Settings saved successfully!</div>';
                    setTimeout(() => {
                        alertDiv.innerHTML = '';
                    }, 3000);
                } else {
                    alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${data.message || 'Failed to save settings'}</div>`;
                }
            } catch (error) {
                alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${error.message}</div>`;
            }
        });
        
        // ========== PASSWORD MANAGEMENT ==========
        
        // Show change password modal
        function showChangePasswordModal() {
            document.getElementById('change-password-current').value = '';
            document.getElementById('change-password-new').value = '';
            document.getElementById('change-password-confirm').value = '';
            document.getElementById('change-password-alert').innerHTML = '';
            document.getElementById('change-password-modal').style.display = 'flex';
        }
        
        // Close change password modal
        function closeChangePasswordModal() {
            document.getElementById('change-password-modal').style.display = 'none';
        }
        
        // Save password change
        async function savePasswordChange() {
            const currentPassword = document.getElementById('change-password-current').value;
            const newPassword = document.getElementById('change-password-new').value;
            const confirmPassword = document.getElementById('change-password-confirm').value;
            const alertDiv = document.getElementById('change-password-alert');
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                alertDiv.innerHTML = '<div class="alert error">All fields are required</div>';
                return;
            }
            
            if (newPassword.length < 6) {
                alertDiv.innerHTML = '<div class="alert error">New password must be at least 6 characters</div>';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alertDiv.innerHTML = '<div class="alert error">New passwords do not match</div>';
                return;
            }
            
            try {
                const response = await fetch('/api/admin/change-password', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alertDiv.innerHTML = '<div class="alert success">‚úÖ Password changed successfully!</div>';
                    setTimeout(() => {
                        closeChangePasswordModal();
                    }, 1500);
                } else {
                    alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${data.message || 'Failed to change password'}</div>`;
                }
            } catch (error) {
                alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Show password reset modal
        function showPasswordResetModal() {
            document.getElementById('reset-password-email').value = '';
            document.getElementById('reset-password-alert').innerHTML = '';
            document.getElementById('password-reset-modal').style.display = 'flex';
        }
        
        // Close password reset modal
        function closePasswordResetModal() {
            document.getElementById('password-reset-modal').style.display = 'none';
        }
        
        // Request password reset
        async function requestPasswordReset() {
            const email = document.getElementById('reset-password-email').value.trim();
            const alertDiv = document.getElementById('reset-password-alert');
            
            if (!email) {
                alertDiv.innerHTML = '<div class="alert error">Email is required</div>';
                return;
            }
            
            try {
                const response = await fetch('/api/admin/password-reset-request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: email })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alertDiv.innerHTML = '<div class="alert success">‚úÖ If the email exists, a password reset link has been sent. Check the console for the reset token (development mode).</div>';
                } else {
                    alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${data.message || 'Failed to send reset link'}</div>`;
                }
            } catch (error) {
                alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // ========== PERMISSIONS MANAGEMENT ==========
        let currentPermissions = null;
        
        // Show permissions modal
        async function showPermissionsModal() {
            document.getElementById('permissions-loading').style.display = 'block';
            document.getElementById('permissions-content').style.display = 'none';
            document.getElementById('permissions-modal').style.display = 'flex';
            
            try {
                const apiUrl = getAPIUrl('/api/admin/permissions');
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        currentPermissions = data.data;
                        renderPermissionsForm(data.data);
                        document.getElementById('permissions-loading').style.display = 'none';
                        document.getElementById('permissions-content').style.display = 'block';
                    }
                }
            } catch (error) {
                document.getElementById('permissions-loading').innerHTML = `<div class="alert error">Error loading permissions: ${error.message}</div>`;
            }
        }
        
        // Close permissions modal
        function closePermissionsModal() {
            document.getElementById('permissions-modal').style.display = 'none';
        }
        
        // Render permissions form
        function renderPermissionsForm(permissions) {
            const formDiv = document.getElementById('permissions-form');
            const allPermissions = [
                'pages.create', 'pages.edit', 'pages.delete', 'pages.view',
                'services.create', 'services.edit', 'services.delete', 'services.view',
                'content.create', 'content.edit', 'content.delete', 'content.view',
                'users.create', 'users.edit', 'users.delete', 'users.view',
                'settings.edit', 'settings.view'
            ];
            
            let html = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">';
            
            Object.keys(permissions.roles).forEach(roleKey => {
                const role = permissions.roles[roleKey];
                html += `
                    <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; border: 2px solid var(--border);">
                        <h4 style="margin-bottom: 1rem; color: var(--primary);">${role.name}</h4>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                `;
                
                allPermissions.forEach(perm => {
                    const checked = role.permissions.includes(perm) ? 'checked' : '';
                    const disabled = roleKey === 'super_admin' ? 'disabled' : '';
                    html += `
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                            <input type="checkbox" data-role="${roleKey}" data-permission="${perm}" ${checked} ${disabled} style="width: auto;">
                            <span>${perm}</span>
                        </label>
                    `;
                });
                
                html += '</div></div>';
            });
            
            html += '</div>';
            formDiv.innerHTML = html;
        }
        
        // Save permissions
        async function savePermissions() {
            if (!currentPermissions) return;
            
            const formDiv = document.getElementById('permissions-form');
            const checkboxes = formDiv.querySelectorAll('input[type="checkbox"]');
            
            // Update permissions from checkboxes
            Object.keys(currentPermissions.roles).forEach(roleKey => {
                const role = currentPermissions.roles[roleKey];
                role.permissions = [];
                
                checkboxes.forEach(checkbox => {
                    if (checkbox.dataset.role === roleKey && checkbox.checked) {
                        role.permissions.push(checkbox.dataset.permission);
                    }
                });
            });
            
            const alertDiv = document.getElementById('permissions-alert');
            
            try {
                const response = await fetch('/api/admin/permissions', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentPermissions)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alertDiv.innerHTML = '<div class="alert success">‚úÖ Permissions saved successfully!</div>';
                    setTimeout(() => {
                        closePermissionsModal();
                    }, 1500);
                } else {
                    alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${data.message || 'Failed to save permissions'}</div>`;
                }
            } catch (error) {
                alertDiv.innerHTML = `<div class="alert error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // ========== CONTACT MESSAGES MANAGEMENT ==========
        
        let allMessages = [];
        let currentMessageView = null;
        
        // Load contact messages
        // Load visitors data
        async function loadVisitors() {
            if (!sessionId) {
                console.warn('loadVisitors: No sessionId available');
                return;
            }
            
            try {
                const apiUrl = getAPIUrl('/api/admin/visitors');
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    console.error('Failed to load visitors:', response.status);
                    document.getElementById('visitors-table-body').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--error);">Error loading visitors</td></tr>';
                    return;
                }
                
                const data = await response.json();
                if (data.success && data.data) {
                    renderVisitors(data.data);
                } else {
                    console.error('Invalid visitors data:', data);
                }
            } catch (error) {
                console.error('Error loading visitors:', error);
                document.getElementById('visitors-table-body').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--error);">Error loading visitors</td></tr>';
            }
        }
        
        // Render visitors data
        function renderVisitors(visitorData) {
            // Update summary stats
            document.getElementById('visitor-total').textContent = visitorData.totalVisitors || 0;
            document.getElementById('visitor-pageviews').textContent = visitorData.totalPageViews || 0;
            document.getElementById('visitor-unique').textContent = visitorData.uniqueVisitors || 0;
            
            // Render visitors table
            const tbody = document.getElementById('visitors-table-body');
            const visitors = visitorData.visitors || [];
            
            if (visitors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-light);">No visitors yet</td></tr>';
                return;
            }
            
            // Sort by last visit (most recent first)
            const sortedVisitors = [...visitors].sort((a, b) => new Date(b.lastVisit) - new Date(a.lastVisit));
            
            let html = '';
            sortedVisitors.forEach(visitor => {
                const firstVisit = new Date(visitor.firstVisit).toLocaleString();
                const lastVisit = new Date(visitor.lastVisit).toLocaleString();
                const country = visitor.country || 'Unknown';
                const city = visitor.city || 'Unknown';
                const countryCode = visitor.countryCode || 'XX';
                
                // Format referrer source
                let sourceDisplay = 'Direct';
                let sourceColor = '#666';
                if (visitor.referrerType === 'Search Engine') {
                    sourceDisplay = `üîç ${visitor.referrerSource || 'Search'}`;
                    sourceColor = '#4CAF50';
                    if (visitor.searchQuery) {
                        sourceDisplay += `<br><small style="color: #999; font-size: 0.8rem;">"${visitor.searchQuery.substring(0, 40)}${visitor.searchQuery.length > 40 ? '...' : ''}"</small>`;
                    }
                } else if (visitor.referrerType === 'Social Media') {
                    sourceDisplay = `üì± ${visitor.referrerSource || 'Social'}`;
                    sourceColor = '#2196F3';
                } else if (visitor.referrerType === 'External') {
                    sourceDisplay = `üîó ${(visitor.referrerSource || 'External').substring(0, 30)}`;
                    sourceColor = '#FF9800';
                } else if (visitor.referrerType === 'Internal') {
                    sourceDisplay = 'üîÑ Internal';
                    sourceColor = '#9C27B0';
                }
                
                // Format visited pages
                const visitedPages = visitor.visitedPages || [];
                let pagesDisplay = 'N/A';
                if (visitedPages.length > 0) {
                    const lastPage = visitedPages[visitedPages.length - 1];
                    pagesDisplay = `<span style="font-weight: 500;">${lastPage}</span>`;
                    if (visitedPages.length > 1) {
                        pagesDisplay += `<br><small style="color: #999; font-size: 0.75rem;">+${visitedPages.length - 1} more</small>`;
                    }
                }
                
                html += `
                    <tr>
                        <td><strong>${countryCode}</strong><br><small style="color: #999;">${country}</small></td>
                        <td>${city}</td>
                        <td style="color: ${sourceColor}; font-size: 0.9rem;">${sourceDisplay}</td>
                        <td style="font-size: 0.85rem;">${pagesDisplay}</td>
                        <td style="font-size: 0.85rem;">${firstVisit}</td>
                        <td style="font-size: 0.85rem;">${lastVisit}</td>
                        <td style="text-align: center;"><strong>${visitor.pageViews || 0}</strong></td>
                        <td style="font-size: 0.8rem; color: var(--text-light);">${(visitor.isp || visitor.userAgent || 'Unknown').substring(0, 40)}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            // Calculate SEO insights
            const trafficSources = {};
            const searchQueries = {};
            
            visitors.forEach(visitor => {
                // Count traffic sources
                const sourceType = visitor.referrerType || 'Direct';
                trafficSources[sourceType] = (trafficSources[sourceType] || 0) + 1;
                
                // Collect search queries
                if (visitor.searchQuery && visitor.referrerType === 'Search Engine') {
                    const query = visitor.searchQuery.toLowerCase().trim();
                    if (query) {
                        searchQueries[query] = (searchQueries[query] || 0) + 1;
                    }
                }
            });
            
            // Render traffic sources
            const trafficSourcesContainer = document.getElementById('traffic-sources-list');
            const sourceEntries = Object.entries(trafficSources).sort((a, b) => b[1] - a[1]);
            if (sourceEntries.length > 0) {
                let sourcesHtml = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
                sourceEntries.forEach(([source, count]) => {
                    const percentage = ((count / visitors.length) * 100).toFixed(1);
                    let icon = 'üåê';
                    let color = '#666';
                    if (source === 'Search Engine') { icon = 'üîç'; color = '#4CAF50'; }
                    else if (source === 'Social Media') { icon = 'üì±'; color = '#2196F3'; }
                    else if (source === 'External') { icon = 'üîó'; color = '#FF9800'; }
                    else if (source === 'Internal') { icon = 'üîÑ'; color = '#9C27B0'; }
                    
                    sourcesHtml += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-light); border-radius: 0.25rem;">
                            <span>${icon} <strong>${source}</strong></span>
                            <span style="color: ${color}; font-weight: bold;">${count} (${percentage}%)</span>
                        </div>
                    `;
                });
                sourcesHtml += '</div>';
                trafficSourcesContainer.innerHTML = sourcesHtml;
            } else {
                trafficSourcesContainer.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-light);">No traffic data yet</div>';
            }
            
            // Render search queries
            const searchQueriesContainer = document.getElementById('search-queries-list');
            const queryEntries = Object.entries(searchQueries).sort((a, b) => b[1] - a[1]).slice(0, 10);
            if (queryEntries.length > 0) {
                let queriesHtml = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
                queryEntries.forEach(([query, count], index) => {
                    queriesHtml += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-light); border-radius: 0.25rem;">
                            <span><strong>${index + 1}.</strong> "${query.substring(0, 40)}${query.length > 40 ? '...' : ''}"</span>
                            <span style="color: #4CAF50; font-weight: bold;">${count}</span>
                        </div>
                    `;
                });
                queriesHtml += '</div>';
                searchQueriesContainer.innerHTML = queriesHtml;
            } else {
                searchQueriesContainer.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-light);">No search queries yet</div>';
            }
            
            // Render top pages
            const topPagesContainer = document.getElementById('top-pages-list');
            if (visitorData.topPages && visitorData.topPages.length > 0) {
                let pagesHtml = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
                visitorData.topPages.slice(0, 10).forEach((page, index) => {
                    pagesHtml += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-light); border-radius: 0.25rem;">
                            <span><strong>${index + 1}.</strong> ${page.path}</span>
                            <span style="color: var(--primary); font-weight: bold;">${page.views} views</span>
                        </div>
                    `;
                });
                pagesHtml += '</div>';
                topPagesContainer.innerHTML = pagesHtml;
            } else {
                topPagesContainer.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-light);">No page views yet</div>';
            }
        }
        
        // Helper function to load visitor analytics (for rendering)
        function loadVisitorAnalytics() {
            // Return empty for now - data comes from API
            return { visitors: [] };
        }
        
        // Chat Conversations
        let allChatConversations = [];
        
        async function loadChatConversations() {
            if (!sessionId) {
                console.warn('loadChatConversations: No sessionId available');
                return;
            }
            
            try {
                const apiUrl = getAPIUrl('/api/admin/chat-conversations');
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    console.error('Failed to load chat conversations:', response.status);
                    document.getElementById('chats-table-body').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--error);">Error loading conversations</td></tr>';
                    return;
                }
                
                const data = await response.json();
                if (data.success && data.data) {
                    allChatConversations = data.data.conversations || [];
                    renderChatConversations(data.data);
                } else {
                    console.error('Invalid chat conversations data:', data);
                    document.getElementById('chats-table-body').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--error);">No conversations data</td></tr>';
                }
            } catch (error) {
                console.error('Error loading chat conversations:', error);
                document.getElementById('chats-table-body').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--error);">Error loading conversations</td></tr>';
            }
        }
        
        function renderChatConversations(chatData) {
            document.getElementById('chat-total').textContent = chatData.total || 0;
            document.getElementById('chat-sessions').textContent = chatData.uniqueSessions || 0;
            
            const tbody = document.getElementById('chats-table-body');
            const conversations = chatData.conversations || [];
            
            if (conversations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-light);">No chat conversations yet</td></tr>';
                return;
            }
            
            let html = '';
            conversations.forEach(conv => {
                const timestamp = new Date(conv.timestamp).toLocaleString();
                const sessionId = conv.sessionId || 'Unknown';
                const userMessage = (conv.userMessage || '').substring(0, 100) + (conv.userMessage && conv.userMessage.length > 100 ? '...' : '');
                const aiResponse = (conv.aiResponse || '').substring(0, 100) + (conv.aiResponse && conv.aiResponse.length > 100 ? '...' : '');
                
                html += `
                    <tr>
                        <td style="font-size: 0.9rem; color: var(--text-light);">${timestamp}</td>
                        <td style="font-family: monospace; font-size: 0.85rem; color: var(--text-light);">${sessionId.substring(0, 20)}...</td>
                        <td style="max-width: 300px; word-wrap: break-word;">${escapeHtml(userMessage) || '<em>No message</em>'}</td>
                        <td style="max-width: 300px; word-wrap: break-word;">${escapeHtml(aiResponse) || '<em>No response</em>'}</td>
                        <td>
                            <button class="btn btn-sm" onclick="viewChatConversation('${conv.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">üëÅÔ∏è View</button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        function viewChatConversation(conversationId) {
            const conversation = allChatConversations.find(c => c.id === conversationId);
            if (!conversation) {
                alert('Conversation not found');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90%; width: 800px; max-height: 90vh;">
                    <div class="modal-header">
                        <h3>Chat Conversation</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 120px);">
                        <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 0.5rem;">
                            <p style="margin: 0.25rem 0;"><strong>Session ID:</strong> <code style="font-family: monospace; font-size: 0.9rem;">${conversation.sessionId || 'Unknown'}</code></p>
                            <p style="margin: 0.25rem 0;"><strong>Time:</strong> ${new Date(conversation.timestamp).toLocaleString()}</p>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="color: var(--primary); margin-bottom: 0.5rem;">üë§ User Message:</h4>
                            <div style="padding: 1rem; background: #e3f2fd; border-left: 4px solid var(--primary); border-radius: 0.25rem; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(conversation.userMessage || 'No message')}</div>
                        </div>
                        <div>
                            <h4 style="color: var(--success); margin-bottom: 0.5rem;">ü§ñ AI Response:</h4>
                            <div style="padding: 1rem; background: #e8f5e9; border-left: 4px solid var(--success); border-radius: 0.25rem; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(conversation.aiResponse || 'No response')}</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function filterChats() {
            const filter = document.getElementById('chats-filter')?.value || 'all';
            const conversations = allChatConversations || [];
            
            let filtered = conversations;
            if (filter === 'recent') {
                const yesterday = new Date();
                yesterday.setHours(yesterday.getHours() - 24);
                filtered = conversations.filter(c => new Date(c.timestamp) >= yesterday);
            } else if (filter === 'today') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                filtered = conversations.filter(c => new Date(c.timestamp) >= today);
            }
            
            const tbody = document.getElementById('chats-table-body');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-light);">No conversations found</td></tr>';
                return;
            }
            
            let html = '';
            filtered.forEach(conv => {
                const timestamp = new Date(conv.timestamp).toLocaleString();
                const sessionId = conv.sessionId || 'Unknown';
                const userMessage = (conv.userMessage || '').substring(0, 100) + (conv.userMessage && conv.userMessage.length > 100 ? '...' : '');
                const aiResponse = (conv.aiResponse || '').substring(0, 100) + (conv.aiResponse && conv.aiResponse.length > 100 ? '...' : '');
                
                html += `
                    <tr>
                        <td style="font-size: 0.9rem; color: var(--text-light);">${timestamp}</td>
                        <td style="font-family: monospace; font-size: 0.85rem; color: var(--text-light);">${sessionId.substring(0, 20)}...</td>
                        <td style="max-width: 300px; word-wrap: break-word;">${escapeHtml(userMessage) || '<em>No message</em>'}</td>
                        <td style="max-width: 300px; word-wrap: break-word;">${escapeHtml(aiResponse) || '<em>No response</em>'}</td>
                        <td>
                            <button class="btn btn-sm" onclick="viewChatConversation('${conv.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">üëÅÔ∏è View</button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Track last message count for notifications
        let lastMessageCount = 0;
        let lastUnreadCount = 0;
        let messageCheckInterval = null;
        
        async function loadContactMessages(showLoading = false) {
            if (!sessionId) {
                console.warn('loadContactMessages: No sessionId available');
                return;
            }
            
            const refreshBtn = document.getElementById('messages-refresh-btn');
            const tbody = document.getElementById('messages-table-body');
            
            // Show loading state
            if (showLoading && refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = '‚è≥ Loading...';
            }
            
            try {
                const filter = document.getElementById('messages-filter')?.value || 'all';
                const unreadOnly = filter === 'unread';
                const apiUrl = getAPIUrl(`/api/admin/contact-messages${unreadOnly ? '?unread=true' : ''}`);
                
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        allMessages = data.data.messages || [];
                        const unreadCount = data.data.unread || 0;
                        const totalCount = data.data.total || 0;
                        
                        renderMessagesTable(allMessages);
                        updateMessagesBadge(unreadCount);
                        
                        // Check for new messages and show notification
                        if (lastMessageCount > 0 && totalCount > lastMessageCount) {
                            const newMessages = totalCount - lastMessageCount;
                            showNewMessageNotification(newMessages, unreadCount);
                        }
                        
                        lastMessageCount = totalCount;
                        lastUnreadCount = unreadCount;
                        
                        // Hide alert after successful load
                        const alertDiv = document.getElementById('messages-alert');
                        if (alertDiv) {
                            alertDiv.style.display = 'none';
                        }
                    } else {
                        tbody.innerHTML = 
                            '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--error);">No messages data in response</td></tr>';
                    }
                } else if (response.status === 401) {
                    // Session expired - try to refresh session or redirect to login
                    console.warn('Session expired, attempting to refresh...');
                    const errorData = await response.json().catch(() => ({ message: 'Unauthorized' }));
                    
                    // Try to check session status
                    try {
                        await checkSession();
                        // If session check passes, retry loading messages
                        if (sessionId) {
                            console.log('Session refreshed, retrying message load...');
                            return loadContactMessages(showLoading);
                        }
                    } catch (checkError) {
                        console.error('Session check failed:', checkError);
                    }
                    
                    // If we get here, session is truly expired
                    tbody.innerHTML = 
                        '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--error);">Session expired. Please refresh the page or log in again.</td></tr>';
                    
                    // Show error alert
                    const alertDiv = document.getElementById('messages-alert');
                    if (alertDiv) {
                        alertDiv.style.display = 'block';
                        alertDiv.style.background = '#f8d7da';
                        alertDiv.style.color = '#721c24';
                        alertDiv.style.borderColor = '#f5c6cb';
                        alertDiv.textContent = 'Session expired. Please refresh the page.';
                    }
                    
                    // Stop auto-refresh if session expired
                    stopMessageAutoRefresh();
                } else {
                    const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
                    tbody.innerHTML = 
                        `<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--error);">Error: ${errorData.message || 'Failed to load messages'}</td></tr>`;
                    
                    // Show error alert
                    const alertDiv = document.getElementById('messages-alert');
                    if (alertDiv) {
                        alertDiv.style.display = 'block';
                        alertDiv.style.background = '#f8d7da';
                        alertDiv.style.color = '#721c24';
                        alertDiv.style.borderColor = '#f5c6cb';
                        alertDiv.textContent = `Error: ${errorData.message || 'Failed to load messages'}`;
                    }
                }
            } catch (error) {
                console.error('Error loading contact messages:', error);
                tbody.innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--error);">Error loading messages: ' + error.message + '</td></tr>';
                
                // Show error alert
                const alertDiv = document.getElementById('messages-alert');
                if (alertDiv) {
                    alertDiv.style.display = 'block';
                    alertDiv.style.background = '#f8d7da';
                    alertDiv.style.color = '#721c24';
                    alertDiv.style.borderColor = '#f5c6cb';
                    alertDiv.textContent = 'Error loading messages. Please try again.';
                }
            } finally {
                // Reset button state
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'üîÑ Refresh';
                }
            }
        }
        
        // Update messages badge in sidebar
        function updateMessagesBadge(unreadCount) {
            const badge = document.getElementById('messages-badge');
            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // Show notification for new messages
        function showNewMessageNotification(newCount, unreadCount) {
            // Show browser notification if permission granted
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(`New Contact Message${newCount > 1 ? 's' : ''}`, {
                    body: `You have ${newCount} new message${newCount > 1 ? 's' : ''} (${unreadCount} unread total)`,
                    icon: '/frontend/src/assets/images/logo.png',
                    tag: 'new-message',
                    requireInteraction: false
                });
            }
            
            // Show alert in admin panel
            const alertDiv = document.getElementById('messages-alert');
            if (alertDiv) {
                alertDiv.style.display = 'block';
                alertDiv.style.background = '#d4edda';
                alertDiv.style.color = '#155724';
                alertDiv.style.borderColor = '#c3e6cb';
                alertDiv.textContent = `üîî ${newCount} new message${newCount > 1 ? 's' : ''} received! (${unreadCount} unread)`;
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 5000);
            }
            
            // Update badge
            updateMessagesBadge(unreadCount);
        }
        
        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('‚úÖ Notification permission granted');
                    }
                });
            }
        }
        
        // Start auto-refresh for messages (check every 30 seconds)
        function startMessageAutoRefresh() {
            if (messageCheckInterval) {
                clearInterval(messageCheckInterval);
            }
            
            messageCheckInterval = setInterval(() => {
                // Only check if messages section is visible or user is on dashboard
                const messagesSection = document.getElementById('messages');
                const overviewSection = document.getElementById('overview');
                const isMessagesVisible = messagesSection && messagesSection.classList.contains('active');
                const isOverviewVisible = overviewSection && overviewSection.classList.contains('active');
                
                if (isMessagesVisible || isOverviewVisible) {
                    loadContactMessages(false); // Silent refresh
                }
            }, 30000); // Check every 30 seconds
        }
        
        // Stop auto-refresh
        function stopMessageAutoRefresh() {
            if (messageCheckInterval) {
                clearInterval(messageCheckInterval);
                messageCheckInterval = null;
            }
        }
        
        // Filter messages
        function filterMessages() {
            loadContactMessages();
        }
        
        // Render messages table
        function renderMessagesTable(messages) {
            const tbody = document.getElementById('messages-table-body');
            
            if (messages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No messages found</td></tr>';
                return;
            }
            
            tbody.innerHTML = messages.map(message => {
                const date = new Date(message.timestamp);
                const isUnread = !message.read;
                const emailStatus = message.emailSent ? 
                    '<span style="color: var(--success);">‚úÖ Sent</span>' : 
                    '<span style="color: var(--error);">‚ùå Failed</span>';
                
                return `
                    <tr style="${isUnread ? 'background: #fff3cd; font-weight: bold;' : ''}">
                        <td style="text-align: center;">
                            ${isUnread ? 'üî¥' : '‚ö™'}
                        </td>
                        <td>${message.name || 'N/A'}</td>
                        <td><a href="mailto:${message.email}" style="color: var(--primary);">${message.email || 'N/A'}</a></td>
                        <td>${message.subject || 'General Inquiry'}</td>
                        <td>${date.toLocaleDateString()} ${date.toLocaleTimeString()}</td>
                        <td>${emailStatus}</td>
                        <td>
                            <button class="btn btn-sm" onclick="viewMessage('${message.id}')" style="margin-right: 0.5rem;">üëÅÔ∏è View</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // View message details
        function viewMessage(messageId) {
            const message = allMessages.find(m => m.id === messageId);
            if (!message) {
                alert('Message not found');
                return;
            }
            
            currentMessageView = message;
            
            // Populate modal
            document.getElementById('message-view-name').textContent = message.name || 'N/A';
            document.getElementById('message-view-email').textContent = message.email || 'N/A';
            document.getElementById('message-view-phone').textContent = message.phone || 'N/A';
            document.getElementById('message-view-subject').textContent = message.subject || 'General Inquiry';
            document.getElementById('message-view-date').textContent = new Date(message.timestamp).toLocaleString();
            document.getElementById('message-view-ip').textContent = message.ipAddress || 'Unknown';
            document.getElementById('message-view-email-status').innerHTML = message.emailSent ? 
                '<span style="color: var(--success);">‚úÖ Email sent successfully</span>' : 
                `<span style="color: var(--error);">‚ùå Email failed: ${message.emailError || 'Unknown error'}</span>`;
            document.getElementById('message-view-message').textContent = message.message || 'No message';
            
            // Set reply link
            const replyLink = document.getElementById('message-reply-link');
            replyLink.href = `mailto:${message.email}?subject=Re: ${encodeURIComponent(message.subject || 'General Inquiry')}`;
            
            // Show modal
            document.getElementById('message-view-modal').style.display = 'flex';
            
            // Mark as read (update locally, could also update on server)
            if (!message.read) {
                message.read = true;
                renderMessagesTable(allMessages);
            }
        }
        
        // Close message view
        function closeMessageView() {
            document.getElementById('message-view-modal').style.display = 'none';
            currentMessageView = null;
        }
        
        // Load messages when messages section is shown
        document.addEventListener('DOMContentLoaded', () => {
            // Request notification permission
            requestNotificationPermission();
            
            // Start auto-refresh
            startMessageAutoRefresh();
            
            // Add event listener for messages section
            const messagesLink = document.querySelector('[data-section="messages"]');
            if (messagesLink) {
                messagesLink.addEventListener('click', () => {
                    setTimeout(() => {
                        loadContactMessages(true);
                    }, 100);
                });
            }
            
            // Load initial message count for badge
            if (sessionId) {
                loadContactMessages(false);
            }
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopMessageAutoRefresh();
        });
    </script>
</body>
</html>

